<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>æ¯æ—¥æ­ä¹˜èª¿æŸ¥ (Proç‰ˆ)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body {
      font-family: "Microsoft JhengHei", Arial, sans-serif;
      background-color: #f9fafb;
      margin: 20px;
      touch-action: manipulation;
    }

    h1 {
      color: #2563eb;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px;
    }

    /* è£ç½®æ¨™ç±¤æ¨£å¼ */
    #deviceTag {
        font-size: 0.6em;
        padding: 5px 10px;
        border-radius: 15px;
        color: white;
        background-color: #6b7280;
        vertical-align: middle;
    }

    .form-group {
      margin-bottom: 15px;
    }

    label {
      font-weight: 600;
      color: #374151;
      display: block;
      margin-bottom: 5px;
    }

    input, select, textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      transition: border-color 0.2s;
      box-sizing: border-box; 
      font-size: 16px;
    }

    textarea {
        min-height: 100px;
        resize: vertical;
    }

    input:focus, select:focus, textarea:focus {
      border-color: #2563eb;
      outline: none;
    }

    /* Choices.js ä¿®æ­£æ¨£å¼ */
    .choices__inner {
        background-color: #fff;
        border-radius: 8px;
        min-height: 44px;
    }

    /* æŒ‰éˆ•æ¨£å¼ */
    button {
      color: white !important;
      border: none;
      border-radius: 8px;
      padding: 12px 16px;
      margin-right: 8px;
      margin-bottom: 10px;
      cursor: pointer;
      font-size: 15px;
      font-weight: 500;
      transition: all 0.2s;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 5px;
    }
    
    button:hover {
        filter: brightness(90%);
        transform: translateY(-1px);
        box-shadow: 0 4px 6px rgba(0,0,0,0.15);
    }
    
    button:active {
        transform: translateY(0);
    }
    
    button:disabled {
        background-color: #9ca3af !important;
        cursor: not-allowed;
        transform: none;
    }

    .btn-blue { background-color: #2563eb !important; }
    .btn-orange { background-color: #f97316 !important; }
    .btn-red { background-color: #dc2626 !important; }
    .btn-purple { background-color: #7c3aed !important; }
    .btn-green { background-color: #059669 !important; }
    .btn-gray { background-color: #4b5563 !important; }

    /* è¡¨æ ¼æ¨£å¼ */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }

    table th, table td {
      padding: 10px;
      border: 1px solid #d1d5db;
      text-align: center;
      font-size: 14px;
    }
    
    table th {
        background-color: #e5e7eb;
        position: sticky;
        top: 0;
        z-index: 10;
    }

    table tbody tr:nth-child(even) {
      background-color: #f3f4f6;
    }
    
    table tbody tr:hover {
        background-color: #e0f2fe; /* æ»‘é¼ æ‡¸åœæ•ˆæœ */
        cursor: pointer;
    }
    
    .table-responsive {
        width: 100%;
        overflow-x: auto;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        max-height: 500px; /* é™åˆ¶é«˜åº¦è®“æ¨™é¡Œå›ºå®š */
        overflow-y: auto;
    }

    /* æœå°‹æ¡†æ¨£å¼ */
    .search-box {
        position: relative;
        margin-bottom: 10px;
    }
    .search-box input {
        padding-left: 35px;
        border: 2px solid #e5e7eb;
    }
    .search-icon {
        position: absolute;
        left: 10px;
        top: 50%;
        transform: translateY(-50%);
        color: #9ca3af;
    }

    /* éŸ¿æ‡‰å¼ä½ˆå±€ */
    .form-container {
        display: block;
    }
    .button-group {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }
    .button-group button {
        width: 100%;
        margin-right: 0;
    }

    @media (min-width: 768px) {
        .form-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .full-width {
            grid-column: span 2;
        }
        .button-group {
            flex-direction: row;
            flex-wrap: wrap;
            align-items: center;
        }
        .button-group button {
            width: auto;
            margin-right: 10px;
        }
    }

    /* Modal æ¨£å¼ */
    .modal {
        display: none; 
        position: fixed; 
        z-index: 1000; 
        left: 0;
        top: 0;
        width: 100%; 
        height: 100%; 
        overflow: auto; 
        background-color: rgba(0,0,0,0.5); 
        backdrop-filter: blur(2px);
    }

    .modal-content {
        background-color: #fefefe;
        margin: 5% auto; 
        padding: 25px;
        border: 1px solid #888;
        width: 90%; 
        max-width: 700px;
        border-radius: 12px;
        box-shadow: 0 10px 25px rgba(0,0,0,0.2);
    }
    .close-btn { float: right; font-size: 28px; cursor: pointer; color: #6b7280; }
    
    .chart-container {
        position: relative;
        height: 300px;
        width: 100%;
        margin-bottom: 20px;
    }

    /* Loading Overlay */
    #loadingOverlay {
        display: none;
        position: fixed;
        top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(255,255,255,0.8);
        z-index: 9999;
        justify-content: center;
        align-items: center;
        flex-direction: column;
    }
    .spinner {
        border: 5px solid #f3f3f3;
        border-top: 5px solid #2563eb;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
        margin-bottom: 10px;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

  </style>
</head>
<body>

  <div id="loadingOverlay">
      <div class="spinner"></div>
      <div style="color: #2563eb; font-weight: bold;">è³‡æ–™è™•ç†ä¸­...</div>
  </div>

  <h1>
      æ¯æ—¥æ­ä¹˜èª¿æŸ¥
      <span id="deviceTag">åµæ¸¬ä¸­...</span>
  </h1>

  <div id="authSection" style="margin-bottom: 20px; padding: 20px; border: 1px solid #e5e7eb; border-radius: 12px; background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
    <h3 style="margin-top: 0; color: #374151;">ğŸ‘¤ ä½¿ç”¨è€…èªè­‰</h3>
    <div id="loginForm">
      <input type="email" id="email" placeholder="Email" style="margin-bottom: 10px;">
      <input type="password" id="password" placeholder="å¯†ç¢¼" style="margin-bottom: 15px;">
      <div class="button-group" style="flex-direction: row;">
        <button type="button" class="btn-blue" onclick="login()">ç™»å…¥</button>
        <button type="button" class="btn-blue" onclick="signup()">è¨»å†Š</button>
      </div>
    </div>
    <div id="userInfo" style="display:none;">
      <p style="font-size: 1.1em;">æ­¡è¿å›ä¾†ï¼Œ<span id="userEmail" style="font-weight: bold; color: #2563eb;"></span></p>
      <button type="button" class="btn-gray" onclick="logout()">ç™»å‡º</button>
    </div>
  </div>

  <form id="surveyForm">
    <div class="form-container">
        <div class="form-group">
            <label for="timestamp">æ™‚é–“æˆ³è¨˜</label>
            <input type="text" id="timestamp" readonly style="background-color: #f3f4f6;"> 
        </div>

        <div class="form-group">
            <label for="weekday">æ˜ŸæœŸ</label>
            <input type="text" id="weekday" readonly style="background-color: #f3f4f6;">
        </div>

        <div class="form-group full-width">
            <label for="operator">å®¢é‹æ¥­è€… (å¯æœå°‹)</label>
            <select id="operator" name="operator" required>
                <option value="" disabled selected>--- è«‹é¸æ“‡å®¢é‹æ¥­è€… ---</option>
                <optgroup label="åŸºéš†/æ–°åŒ—/è‡ºåŒ—">
                    <option value="KeelungCity">åŸºéš†å¸‚å…¬è»Šè™•</option>
                    <option value="KeelungBus">åŸºéš†å®¢é‹</option>
                    <option value="CapitalBus">é¦–éƒ½å®¢é‹</option>
                    <option value="TaipeiBus">è‡ºåŒ—å®¢é‹</option>
                    <option value="ZhinanBus">æŒ‡å—å®¢é‹</option>
                    <option value="NewTaipeiBus">æ–°åŒ—å®¢é‹</option>
                    <option value="SanChung">ä¸‰é‡å®¢é‹</option>
                    <option value="KuoKuang">åœ‹å…‰å®¢é‹</option>
                    <option value="MetropolitanTransport">å¤§éƒ½æœƒå®¢é‹</option>
                    <option value="ZhongxingBus">ä¸­èˆˆå·´å£«</option>
                    <option value="Kuang-HuaBus">å…‰è¯å·´å£«</option>
                    <option value="DaNan">å¤§å—æ±½è»Š</option>
                    <option value="HsinBus">æ¬£æ¬£å®¢é‹</option>
                    <option value="SindianBus">æ–°åº—å®¢é‹</option>
                    <option value="TamshuiBus">æ·¡æ°´å®¢é‹</option>
                    <option value="TaoyuanBus">æ¡ƒåœ’å®¢é‹</option>
                    <option value="howtai">è±ªæ³°å®¢é‹</option>
                    <option value="southeastBus">æ±å—å®¢é‹</option>
                    <option value="CitiAirBus">å¤§æœ‰å·´å£«</option>
                </optgroup>
                <optgroup label="æ¡ƒåœ’">
                    <option value="TaoyuanBus">æ¡ƒåœ’å®¢é‹</option>
                    <option value="ZhongliBus">ä¸­å£¢å®¢é‹</option>
                    <option value="YatungBus">äºé€šå®¢é‹</option>
                    <option value="UnitedBus">çµ±è¯å®¢é‹</option>
                    <option value="SanChung">ä¸‰é‡å®¢é‹</option>
                    <option value="ZhinanBus">æŒ‡å—å®¢é‹</option>
                    <option value="ChampionTransportation">é‡‘å°å®¢é‹</option>
                    <option value="Jet-ChenBus">æ·ä¹˜å®¢é‹</option>
                </optgroup>
                 <optgroup label="æ–°ç«¹/è‹—æ —">
                  <option value="HsinchuBus">æ–°ç«¹å®¢é‹</option>
                  <option value="KuoKuang">åœ‹å…‰å®¢é‹</option>
                  <option value="ChampionTransportation">é‡‘ç‰Œå®¢é‹</option>
                  <option value="YosemiteBus">ç§‘æŠ€ä¹‹æ˜Ÿ</option>
                  <option value="MiaoLi">è‹—æ —å®¢é‹</option>
                  <option value="Jet-ChenBus">æ·ä¹˜å®¢é‹</option>
                  <option value="Yi-JetTechIntegration">äº¦æ·ç§‘éš›</option>
                  <option value="FengyuanBus">è±åŸå®¢é‹</option>
                </optgroup>
                <optgroup label="è‡ºä¸­å¸‚å„æ¥­è€…">
                  <option value="TaichungBus">è‡ºä¸­å®¢é‹</option>
                  <option value="UnitedBus">çµ±è¯å®¢é‹</option>
                  <option value="GeyaBus">å·¨æ¥­äº¤é€š</option>
                  <option value="ChuanHang">å…¨èˆªå®¢é‹</option>
                  <option value="FengyuanBus">è±åŸå®¢é‹</option>
                  <option value="southeastBus">æ±å—å®¢é‹</option>
                  <option value="MiaoLiBus">è‹—æ —å®¢é‹</option>
                  <option value="UnitedBus1">ä¸­å°ç£å®¢é‹</option>
                  <option value="HO-HSINBus">å’Œæ¬£å®¢é‹</option>
                  <option value="Chung-LuBus">ä¸­é¹¿å®¢é‹</option>
                  <option value="AllDayBus">ç¸½é”å®¢é‹</option>
                  <option value="KuoKuang">åœ‹å…‰å®¢é‹</option>
                  <option value="freego">å»ºæ˜å®¢é‹</option>
                  <option value="RuiyiTransportation">ç¿å¥•äº¤é€š</option>
                </optgroup>
                <optgroup label="å½°åŒ–">
                  <option value="ChanghuaBus">å½°åŒ–å®¢é‹</option>
                  <option value="YuanLinBus">å“¡æ—å®¢é‹</option>
                  <option value="Chung-LuBus">ä¸­é¹¿å®¢é‹</option>
                  <option value="TaichungBus">è‡ºä¸­å®¢é‹</option>
                  <option value="GeyaBus">å·¨æ¥­äº¤é€š</option>
                  <option value="taisibus">å°è¥¿å®¢é‹</option>
                  <option value="UnitedBus">çµ±è¯å®¢é‹</option>
                  <option value="KuoKuang">åœ‹å…‰å®¢é‹</option>
                  <option value="NANTOUBUS">å—æŠ•å®¢é‹</option>
                </optgroup>
                <optgroup label="å—æŠ•">
                  <option value="NANTOUBUS">å—æŠ•å®¢é‹</option>
                  <option value="ChanghuaBus">å½°åŒ–å®¢é‹</option>
                  <option value="YuanLinBus">å“¡æ—å®¢é‹</option>
                  <option value="AllDayBus">ç¸½é”å®¢é‹</option>
                  <option value="TaichungBus">è‡ºä¸­å®¢é‹</option>
                  <option value="goto307">æ‰æ—æºªå®¢é‹</option>
                  <option value="GreenTransit">è±æ¦®å®¢é‹</option>
                  <option value="ChuanHang">å…¨èˆªå®¢é‹</option>
                  <option value="UnitedBus">çµ±è¯å®¢é‹</option>
                </optgroup>
                <optgroup label="é›²æ—">
                  <option value="taisibus">å°è¥¿å®¢é‹</option>
                  <option value="YunlinBus">é›²æ—å®¢é‹</option>
                  <option value="SOLARbus">æ—¥çµ±å®¢é‹</option>
                  <option value="ChiayiBus">å˜‰ç¾©å®¢é‹</option>
                  <option value="UnitedBus">çµ±è¯å®¢é‹</option>
                </optgroup>
                <optgroup label="å˜‰ç¾©">
                  <option value="ChiayiCountyBus">å˜‰ç¾©ç¸£å…¬è»Šè™•</option>
                  <option value="ChiayiBus">å˜‰ç¾©å®¢é‹</option>
                  <option value="taisibus">å°è¥¿å®¢é‹</option>
                  <option value="YunlinBus">é›²æ—å®¢é‹</option>
                  <option value="AlishanBus">é˜¿é‡Œå±±å®¢é‹</option>
                  <option value="HO-HSINBus">å’Œæ¬£å®¢é‹</option>
                  <option value="KuoKuang">åœ‹å…‰å®¢é‹</option>
                  <option value="Jet-ChenBus">æ·ä¹˜å®¢é‹</option>
                </optgroup>
                <optgroup label="è‡ºå—">
                  <option value="SinhuaBus">èˆˆå—å®¢é‹</option>
                  <option value="SingingBus">æ–°ç‡Ÿå®¢é‹</option>
                  <option value="TainanBus">åºœåŸå®¢é‹</option>
                  <option value="Han-ChengBus">æ¼¢ç¨‹å®¢é‹</option>
                  <option value="GeyaBus">å·¨æ¥­äº¤é€š</option>
                  <option value="UnitedBus">çµ±è¯å®¢é‹</option>
                </optgroup>
                <optgroup label="é«˜é›„">
                  <option value="KaohsiungBus">é«˜é›„å®¢é‹</option>
                  <option value="SouthTaiwanBus">å—è‡ºç£å®¢é‹</option>
                  <option value="Han-ChengBus">æ¼¢ç¨‹å®¢é‹</option>
                  <option value="GreatCityLifeBus">æ¸¯éƒ½å®¢é‹</option>
                  <option value="E-DaBus">ç¾©å¤§å®¢é‹</option>
                  <option value="UnitedBus">çµ±è¯å®¢é‹</option>
                  <option value="southeastBus">æ±å—å®¢é‹</option>
                </optgroup>
                <optgroup label="å±æ±">
                  <option value="PingTungBus">å±æ±å®¢é‹</option>
                  <option value="KaohsiungBus">é«˜é›„å®¢é‹</option>
                  <option value="Jet-ChenBus">æ·ä¹˜å®¢é‹</option>
                </optgroup>
                <optgroup label="æ±éƒ¨ç¸£å¸‚">
                  <option value="MetropolitanTransport">å¤§éƒ½æœƒå®¢é‹</option>
                  <option value="CapitalBus">é¦–éƒ½å®¢é‹</option>
                  <option value="KamalanBus">è‘›ç‘ªè˜­å®¢é‹</option>
                  <option value="KuoKuang">åœ‹å…‰å®¢é‹</option>
                  <option value="TarokoBus">å¤ªé­¯é–£å®¢é‹</option>
                  <option value="hopelandbus">è¯è¯å®¢é‹</option>
                  <option value="UnitedBus">çµ±è¯å®¢é‹</option>
                  <option value="DiingDongBus">é¼æ±å®¢é‹</option>
                  <option value="ShingDongBus">èˆˆæ±å®¢é‹</option>
                  <option value="PuyumaTransportation">æ™®æ‚ ç‘ªå®¢é‹</option>
                  <option value="EasternTopTransportation">æ±å°ç£å®¢é‹</option>
                </optgroup>
                 <optgroup label="é›¢å³¶">
                  <option value="phpto">æ¾æ¹–ç¸£å…¬è»Šè™•</option>
                  <option value="matsuebus">é€£æ±Ÿç¸£å…¬å…±è»Šèˆ¹ç®¡ç†è™•</option>
                  <option value="Kinmen">é‡‘é–€ç¸£å…¬å…±è»Šèˆ¹ç®¡ç†è™•</option>
                </optgroup>
                <optgroup label="å…¶ä»–/è·¨å€">
                    <option value="Other">å…¶ä»–æ¥­è€…</option>
                </optgroup>
            </select>
        </div>

        <div class="form-group">
            <label for="manufacturer">è»Šå»  (æ ¹æ“šæ¥­è€…è‡ªå‹•åˆ—å‡º)</label>
            <select id="manufacturer" name="manufacturer">
                <option value="" selected>--- è«‹å…ˆé¸æ“‡å®¢é‹æ¥­è€… ---</option>
            </select>
        </div>

        <div class="form-group">
            <label>è·¯ç·šè™Ÿç¢¼</label>
            <input type="text" id="routeCode" placeholder="ä¾‹: 307, è—ç·š">
        </div>

        <div class="form-group">
            <label>è»Šè™Ÿ</label>
            <input type="text" id="busNumber" required placeholder="ä¾‹: KKA-1234">
        </div>

        <div class="form-group">
            <label>è»Šå‹</label>
            <select id="busType" name="busType" required>
                <option value="" disabled selected>--- è«‹é¸æ“‡è»Šå‹ ---</option>
                <option value="dieselbus">æŸ´æ²¹å·´å£«</option>
                <option value="electricbus">é›»å‹•å·´å£«</option>
                <option value="articulatedbus">é›™ç¯€å·´å£«</option>
                <option value="minibus">å°å‹å·´å£«</option>
                <option value="Freewaybusservice">åœ‹é“å®¢é‹</option>
                <option value="Other">å…¶ä»–</option>
            </select>
        </div>

        <div class="form-group full-width">
            <label>å‚™è¨»</label>
            <textarea id="note" placeholder="è·¯æ³ã€å¸æ©Ÿã€æ“æ“ ç¨‹åº¦..."></textarea>
        </div>

        <div class="button-group full-width">
            <button type="button" onclick="saveData()" class="btn-orange">ğŸ’¾ å„²å­˜ç´€éŒ„</button>
            <button type="button" onclick="saveEdit()" class="btn-blue" id="btnEdit" style="display:none;">âœï¸ å„²å­˜ä¿®æ”¹</button>
            <button type="button" onclick="deleteRecord()" class="btn-red" id="btnDelete" style="display:none;">ğŸ—‘ï¸ åˆªé™¤ç´€éŒ„</button>
            <button type="button" onclick="cancelEdit()" class="btn-gray" id="btnCancel" style="display:none;">âŒ å–æ¶ˆç·¨è¼¯</button>
            
            <input type="file" id="importFile" accept=".xlsx, .xls, .csv" style="display:none" onchange="handleFileSelect(this)">
            <button type="button" onclick="document.getElementById('importFile').click()" class="btn-green">ğŸ“¥ åŒ¯å…¥è³‡æ–™</button>
            <button type="button" onclick="exportCSV()" class="btn-blue">ğŸ“¤ åŒ¯å‡º CSV</button>
            <button type="button" onclick="showStats()" class="btn-purple">ğŸ“Š çµ±è¨ˆåœ–è¡¨</button>
            <button type="button" onclick="showBusStats()" class="btn-green">ğŸšŒ è»Šè™Ÿçµ±è¨ˆåˆ—è¡¨</button>
            <button type="button" onclick="deleteAllRecords()" class="btn-red">âš ï¸ æ¸…ç©ºå…¨éƒ¨</button>
        </div>
    </div>
  </form>

  <hr style="margin: 30px 0; border: 0; border-top: 1px solid #e5e7eb;">

  <h2>ç´€éŒ„æ¸…å–®</h2>
  <div class="search-box">
      <span class="search-icon">ğŸ”</span>
      <input type="text" id="tableSearch" placeholder="æœå°‹ç´€éŒ„... (è¼¸å…¥è»Šè™Ÿã€è·¯ç·šæˆ–æ¥­è€…)" onkeyup="filterTable()">
  </div>
  
  <div class="table-responsive">
      <table border="1" id="recordTable">
        <thead>
          <tr>
            <th>æ™‚é–“</th><th>æ˜ŸæœŸ</th><th>å®¢é‹æ¥­è€…</th>
            <th>è»Šå» </th><th>è·¯ç·š</th><th>è»Šè™Ÿ</th>
            <th>è»Šå‹</th><th>å‚™è¨»</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
  </div>

  <div id="statsModal" class="modal">
    <div class="modal-content">
      <span class="close-btn" onclick="closeStats()">&times;</span>
      <h2 style="text-align: center; color: #2563eb;">ğŸ“Š æ­ä¹˜çµ±è¨ˆåˆ†æ</h2>
      
      <div style="display: flex; justify-content: space-around; margin-bottom: 20px; font-size: 1.2em;">
          <div>ç¸½æ¬¡æ•¸: <b id="statTotal" style="color:#2563eb">0</b></div>
          <div>ä¸åŒè»Šè¼›: <b id="statUnique" style="color:#059669">0</b></div>
      </div>

      <div class="chart-container">
          <canvas id="operatorChart"></canvas>
      </div>
      <div class="chart-container">
          <canvas id="routeChart"></canvas>
      </div>
    </div>
  </div>

    <div id="busStatsModal" class="modal">
    <div class="modal-content wide-modal">
      <span class="close-btn" onclick="closeBusStats()">&times;</span>
      <h2 style="text-align: center; color: #059669;">ğŸšŒ è»Šè™Ÿçµ±è¨ˆåˆ—è¡¨</h2>
      <p style="text-align: center; margin-bottom: 20px; color: #666;">ä¾ç…§è»Šè™Ÿæ’åº (A-Z)</p>
      <div class="table-responsive">
          <table class="bus-list-table">
            <thead><tr><th>è»Šè™Ÿ</th><th>æ¬¡æ•¸</th><th>æ‰€å±¬å®¢é‹æ¥­è€…</th></tr></thead>
            <tbody id="busListBody"></tbody>
          </table>
      </div>
    </div>
  </div>

<script>
// --- 1. Firebase åˆå§‹åŒ– ---
const firebaseConfig = {
    apiKey: "AIzaSyAKTHlEzkOx8uZWOcfTr8YHZj6-bd74MeE",
    authDomain: "jun-bus.firebaseapp.com",
    projectId: "jun-bus",
    storageBucket: "jun-bus.firebasestorage.app",
    messagingSenderId: "685457601811",
    appId: "1:685457601811:web:02f59887b6895879ac96e6",
    measurementId: "G-HPTP7MMCDV"
};
if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// --- 2. å…¨åŸŸè®Šæ•¸èˆ‡è³‡æ–™ ---
let editDocId = null;
let globalRecords = [];
let operatorChoiceInstance = null;
let charts = {}; // å­˜æ”¾ Chart.js å¯¦ä¾‹

const OPERATOR_NAMES = {
    "KeelungCity": "åŸºéš†å¸‚å…¬è»Šè™•", "KeelungBus": "åŸºéš†å®¢é‹", "CapitalBus": "é¦–éƒ½å®¢é‹", "TaipeiBus": "è‡ºåŒ—å®¢é‹",
    "ZhinanBus": "æŒ‡å—å®¢é‹", "NewTaipeiBus": "æ–°åŒ—å®¢é‹", "SanChung": "ä¸‰é‡å®¢é‹", "KuoKuang": "åœ‹å…‰å®¢é‹",
    "MetropolitanTransport": "å¤§éƒ½æœƒå®¢é‹", "ZhongxingBus": "ä¸­èˆˆå·´å£«", "Kuang-HuaBus": "å…‰è¯å·´å£«", "DaNan": "å¤§å—æ±½è»Š",
    "HsinBus": "æ¬£æ¬£å®¢é‹", "SindianBus": "æ–°åº—å®¢é‹", "TamshuiBus": "æ·¡æ°´å®¢é‹", "TaoyuanBus": "æ¡ƒåœ’å®¢é‹",
    "FuhobusInc": "ç¦å’Œå®¢é‹", "RoyalBus": "çš‡å®¶å®¢é‹", "howtai": "è±ªæ³°å®¢é‹", "southeastBus": "æ±å—å®¢é‹",
    "CitiAirBus": "å¤§æœ‰å·´å£«", "ZhongliBus": "ä¸­å£¢å®¢é‹", "HsinchuBus": "æ–°ç«¹å®¢é‹", "YatungBus": "äºé€šå®¢é‹",
    "UnitedBus": "çµ±è¯å®¢é‹", "ChampionTransportation": "é‡‘å°å®¢é‹", "UnitedBus1": "ä¸­å°ç£å®¢é‹",
    "YosemiteBus": "ç§‘æŠ€ä¹‹æ˜Ÿ", "MiaoLi": "è‹—æ —å®¢é‹", "Jet-ChenBus": "æ·ä¹˜å®¢é‹", "Yi-JetTechIntegration": "äº¦æ·ç§‘éš›",
    "FengyuanBus": "è±åŸå®¢é‹", "TaichungBus": "è‡ºä¸­å®¢é‹", "GeyaBus": "å·¨æ¥­äº¤é€š", "ChuanHang": "å…¨èˆªå®¢é‹",
    "MiaoLiBus": "è‹—æ —å®¢é‹", "HO-HSINBus": "å’Œæ¬£å®¢é‹", "Chung-LuBus": "ä¸­é¹¿å®¢é‹", "AllDayBus": "ç¸½é”å®¢é‹",
    "freego": "å»ºæ˜å®¢é‹", "RuiyiTransportation": "ç¿å¥•äº¤é€š", "NANTOUBUS": "å—æŠ•å®¢é‹", "ChanghuaBus": "å½°åŒ–å®¢é‹",
    "YuanLinBus": "å“¡æ—å®¢é‹", "taisibus": "å°è¥¿å®¢é‹", "goto307": "æ‰æ—æºªå®¢é‹",
    "GreenTransit": "è±æ¦®å®¢é‹", "YunlinBus": "é›²æ—å®¢é‹", "SOLARbus": "æ—¥çµ±å®¢é‹", "ChiayiBus": "å˜‰ç¾©å®¢é‹",
    "ChiayiCountyBus": "å˜‰ç¾©ç¸£å…¬è»Šè™•", "AlishanBus": "é˜¿é‡Œå±±å®¢é‹", "SinhuaBus": "èˆˆå—å®¢é‹", "SingingBus": "æ–°ç‡Ÿå®¢é‹",
    "TainanBus": "åºœåŸå®¢é‹", "Han-ChengBus": "æ¼¢ç¨‹å®¢é‹", "KaohsiungBus": "é«˜é›„å®¢é‹", "E-DaBus": "ç¾©å¤§å®¢é‹",
    "SouthTaiwanBus": "å—è‡ºç£å®¢é‹", "GreatCityLifeBus": "æ¸¯éƒ½å®¢é‹", "PingTungBus": "å±æ±å®¢é‹", "KamalanBus": "è‘›ç‘ªè˜­å®¢é‹",
    "TarokoBus": "å¤ªé­¯é–£å®¢é‹", "hopelandbus": "è¯è¯å®¢é‹", "DiingDongBus": "é¼æ±å®¢é‹", "ShingDongBus": "èˆˆæ±å®¢é‹",
    "PuyumaTransportation": "æ™®æ‚ ç‘ªå®¢é‹", "EasternTopTransportation": "æ±å°ç£å®¢é‹", "TailianBus": "å°è¯å®¢é‹",
    "Kinmen": "é‡‘é–€ç¸£å…¬å…±è»Šèˆ¹ç®¡ç†è™•", "matsuebus": "é€£æ±Ÿç¸£å…¬å…±è»Šèˆ¹ç®¡ç†è™•", "phpto": "æ¾æ¹–ç¸£å…¬è»Šè™•", 
    "Other": "å…¶ä»–æ¥­è€…"
};

const BUSTYPE_NAMES = {
    "dieselbus": "æŸ´æ²¹å·´å£«", "electricbus": "é›»å‹•å·´å£«", "articulatedbus": "é›™ç¯€å·´å£«",
    "minibus": "å°å‹å·´å£«", "Freewaybusservice": "åœ‹é“å®¢é‹", "Other": "å…¶ä»–"
};

// ç°¡åŒ–çš„è»Šå» å°ç…§è¡¨
const operatorToManufacturer = {
    "TaichungBus": ["éœ§å³°ç«™", "è±åŸç«™", "æ±æµ·ç«™", "é«˜éµç«™", "æ¸…æ°´ç«™", "æ²™é¹¿ç«™", "å¤§ç”²ç«™", "åœ‹é“ç«™", "æ¢§æ£²ç«™"],
    "UnitedBus": ["è±å‹¢ç«™", "æ¸…æ°´ç«™", "çƒæ—¥ç«™", "æ–°ç¦ç«™", "éœ§å³°ç«™", "ä¸­ç§‘ç«™", "å¹²åŸç«™", "å…‰å¾©ç«™", "å¤§åœ’ç«™", "æ±å‹‡ç«™", "å…«å¾·ç«™", "å¹³é®ç«™", "é‡‘é¦¬ç«™", "è¥¿æ¸¯ç«™", "ç«¹å±±ç«™", "æ–—å…­ç«™", "åŒ—æ¸¯ç«™", "å˜‰ç¾©ç«™", "æ°¸åº·ç«™", "é¼“å±±ç«™", "ç¾…æ±ç«™", "èŠ±è“®ç«™", "ç‘è±ç«™"],
    "GeyaBus": ["å¤§ç”²ç«™", "æ²™é¹¿ç«™", "å¶ºæ±ç«™", "è¯é‚¦åœè»Šå ´"],
    "ChuanHang": ["æ—±æºªç«™", "è¯é‚¦åœè»Šå ´"],
    "FengyuanBus": ["å°ä¸­ç«™", "è±åŸç«™", "æ±å‹¢ç«™", "å¤§ç”²ç«™", "è°·é—œç«™", "å“è˜­ç«™", "æ¢§æ£²ç«™"],
    "southeastBus": ["è‹‘è£¡ç«™", "å¤§é‡Œç«™", "å…§æ¹–ç«™", "è¬èŠ³ç«™", "é«˜é›„ç«™"],
    "MiaoLiBus": ["å—è‹—ç«™", "é ­ä»½ç«™", "å—åº„ç«™", "è‹‘è£¡ç«™", "æ–°ç«¹ç«™", "è‹—æ —ç«™"],
    "UnitedBus1": ["è±å‹¢ç«™", "æ¸…æ°´ç«™", "çƒæ—¥ç«™", "æ–°ç¦ç«™", "éœ§å³°ç«™", "ä¸­ç§‘ç«™", "å¹²åŸç«™"],
    "HO-HSINBus": ["å°åŒ—ç«™", "å°ä¸­ç«™", "å°å—ç«™", "é«˜é›„ç«™"],
    "Chung-LuBus": ["å¤§ç”²ç«™", "åŒ—å±¯ç«™", "å¶ºæ±ç«™", "è¯é‚¦åœè»Šå ´"],
    "AllDayBus": ["å°ä¸­ç«™", "æ°´é‡Œç«™", "å—æŠ•ç«™"],
    "KuoKuang": ["å¹²åŸç«™", "äº”è‚¡ç«™", "æš–æš–ç«™", "é‡‘å±±ç«™", "ç¾…æ±ç«™", "å®œè˜­ç«™", "æ¡ƒåœ’ç«™", "ä¸­å£¢ç«™", "æ–°ç«¹ç«™", "ç«¹æ±ç«™", "è‹—æ —ç«™", "å½°åŒ–ç«™", "å—æŠ•ç«™", "åŸ”é‡Œç«™", "å˜‰ç¾©ç«™", "å°å—ç«™"],
    "freego": ["è‹‘è£¡ç«™(æ±å—å®¢é‹)"],
    "RuiyiTransportation": ["æ¢§æ£²ç«™", "å¤§ç”²ç«™", "æ±æµ·å¤§å­¸"],
    "NANTOUBUS": ["åŸ”é‡Œç«™"],
    "ChanghuaBus": ["å½°åŒ–ç«™", "å“¡æ—ç«™", "æ°´å°¾ç«™", "é¹¿æ¸¯ç«™", "å—æŠ•ç«™", "è‰å±¯ç«™", "ç”°ä¸­ç«™"],
    "YuanLinBus": ["æºªæ¹–ç«™", "äºŒæ—ç«™", "å“¡æ—ç«™", "å½°åŒ–ç«™", "ç”°ä¸­ç«™", "å°ä¸­ç«™", "ç«¹å±±ç«™", "æ°´é‡Œç«™", "é¹¿è°·ç«™"],
    "CapitalBus": ["ä¸‰é‡ä¸€ç«™", "ä¸‰é‡äºŒç«™", "äºŒé‡ç«™", "æ–°èŠä¸€ç«™", "æ–°èŠäºŒç«™", "æ–°èŠç«™(å¤§éƒ½æœƒå®¢é‹)", "ä¸‰å³½ä¸€ç«™(å°åŒ—å®¢é‹)", "å…§æ¹–ç«™", "æ±åœ’ç«™", "å£«æ—ç«™", "å—æ¸¯ç«™", "ç¶“è²¿æ–°ç«™(å……é›»ç«™)", "ç¶“è²¿ç«™", "æ±æ­¢ä¸€ç«™", "æ±æ­¢äºŒç«™", "ç¤¾å­ç«™", "å®‰åº·ç«™", "ç¾…æ±ç«™", "æ°‘ç”Ÿç«™(å°åŒ—å®¢é‹)", "æ¿æ©‹å‰ç«™(å°åŒ—å®¢é‹)", "æ¿æ©‹ç«™", "å…«æ–—å­ç«™", "åŸºéš†ç«™", "èŠ±è“®ç«™", "äº”çµç«™"],
    "KamalanBus": ["å¤§åœ’ç«™", "ç¾…æ±ç«™"],
    "YatungBus": ["æ–°åº—ç«™", "æ–°ç«¹ç«™"],
    "KeelungBus": ["åŸºéš†ç«™", "é‡‘å±±ç«™", "ç‘èŠ³ç«™", "åœŸåŸç«™"],
    "NewTaipeiBus": ["äº”å µç«™", "åŒ—å£«ç§‘ç«™(å…‰è¯å·´å£«)"],
    "SanChung": ["è˜†æ´²ä¸€ç«™", "è˜†æ´²äºŒç«™", "æ–°èŠç«™", "ä¸­æ¸¯ç«™", "åœŸåŸç«™", "å…«é‡Œç«™", "äº”è‚¡ç«™", "äº”è‚¡äºŒç«™", "æ¨¹æ—ç«™", "è¿´é¾ç«™", "æ·¡æµ·ç«™", "å…¬è¥¿ç«™", "æ—å£ç«™", "å—æ¸¯ç«™"],
    "SindianBus": ["æ–°åº—ç«™", "éŒ¦ç¹¡ç«™"],
    "TaoyuanBus": ["ä¸­å£¢å…¬è»Šç«™", "è§€éŸ³ç«™", "å¤§æºªç«™", "ä¸­å£¢ç«™", "ç«¹åœç«™", "é¾æ½­ç«™", "å¤§åœ’ç«™", "ä¸‰å³½ç«™", "æ¡ƒåœ’å…¬è»Šç«™", "ä¸­å£¢ç«™"],
    "HsinchuBus": ["æ–°ç«¹ç«™"],
    "SinhuaBus": ["å®‰å¹³å·¥æ¥­å€", "è‡ºå—ç«è»Šç«™", "ä½³é‡Œç«™", "æ–°åŒ–ç«™", "éº»è±†ç«™", "ç‰äº•ç«™", "æ¥ è¥¿ç«™"],
    "CitiAirBus": ["èˆŠèŠç«™", "æ–°èŠç«™", "ä¸­è¯ç«™"],
    "howtai": ["äº”è‚¡ç«™", "é¦™å±±ç«™"],
    "TaipeiBus": ["å—é›…ç«™", "æ­¡ä»”åœ’ç«™", "æ¿æ©‹å¾Œç«™", "äº”ç¦ç«™", "å››æµ·ç«™", "ä¸­å’Œç«™", "æ¨¹æ—ç«™", "æ–°åº—ç«™", "ä¸‰å³½ä¸€ç«™", "ä¸‰å³½äºŒç«™", "æœ¨æŸµç«™", "ä¸­è¯ç«™", "æ—å£ç«™", "è˜†æ´²ç«™", "æ°‘ç”Ÿç«™", "æ¿æ©‹å‰ç«™", "æ±Ÿå­ç¿ ç«™", "å£«æ—ç«™(é¦–éƒ½å®¢é‹)", "è±¡é ­åŸ”åœè»Šå ´", "ç‘èŠ³ç«™", "è˜‡æ¾³ç«™(å¤§éƒ½æœƒå®¢é‹)", "èŠ±è“®ç«™"],
    "HsinBus": ["ä¸­å¤®ç«™", "ä¸­èˆˆç«™", "å¯Œå¾·ç«™", "æœ¨æŸµäºŒç«™(å……é›»ç«™)", "æœ¨æŸµç«™(å……é›»ç«™)", "æ±æ¹–ç«™", "æ·±å‘ç«™", "è¯æ±Ÿç«™", "æ™¯æ–°ç«™", "æ™¯å¾·ç«™", "èˆˆéš†åœè»Šå ´"],
    "DaNan": ["ç§€å±±ç«™", "åœŸåŸç«™", "é—œæ¸¡ç«™", "å…§æ¹–ç«™", "ä¸­å¤®ç«™(æ¬£æ¬£å®¢é‹)", "æ™¯æ–°ç«™(æ¬£æ¬£å®¢é‹)", "ä¸‰é¶¯è½‰é‹ç«™"],
    "NewTaipeiBus": ["äº”å µç«™", "åŒ—å£«ç§‘ç«™(å…‰è¯å·´å£«)"],
    "ZhongxingBus": ["ä¸­å’Œç«™", "æ±æ­¢ç«™", "å¤©æ¯ç«™", "æ•…å®®ç«™", "æ³°å±±ç«™", "ä¸‰é‡ç«™", "ä¸‰èŠç«™(æ·¡æ°´å®¢é‹)", "åŒ—å£«ç§‘å……é›»ç«™(å…‰è¯å·´å£«)", "åŒ—å£«ç§‘ç«™(å…‰è¯å·´å£«)", "ä¸­å£¢ç«™"],
    "TamshuiBus": ["æ·¡æ°´ç«™", "ä¸‰èŠç«™", "å…«é‡Œç«™", "æ–°å¸‚ç«™"],
    "ZhinanBus": ["æ–°å…‰ç«™", "æ·±å‘ç«™", "å®‰å’Œç«™", "æ·¡æµ·ç«™", "æ¨¹æ—ç«™", "éŒ¦ç¹¡ç«™", "æ·¡å¤§ç«™", "äº”è‚¡ç«™", "æ³°å±±ç«™", "æ•…å®®ç«™(ä¸­èˆˆå·´å£«)", "éºŸå…‰ç«™", "ä¸‰é‡ç«™(ä¸­èˆˆå·´å£«)", "æ–°å¸‚ç«™(æ·¡æ°´å®¢é‹)", "å…«é‡Œç«™(æ·¡æ°´å®¢é‹)", "æ¡ƒåœ’ç«™", "åŒ—å£«ç§‘å……é›»ç«™(å…‰è¯å·´å£«)"],
    "MetropolitanTransport": ["å…§æ¹–ç«™", "è¬èŠ³ç«™", "é™½æ˜å±±ç«™", "æ±åœ’ç«™", "è˜†æ´²ç«™", "æ¾å¾·ç«™", "æ¦®ç¸½ç«™", "å³èˆˆè¡—ç«™", "ä¸­å’Œç«™", "å››æµ·ç«™(è‡ºåŒ—å®¢é‹)", "å‡Œé›²ç«™", "æ±æ¹–ç«™", "æ¾è·ç«™", "éºŸå…‰ç«™", "èˆŠèŠç«™", "å£«æ—ç«™", "å»ºåŒ—ç«™", "æ–°èŠç«™", "è˜‡æ¾³ç«™", "åŸºéš†ç«™", "æ—å£ç«™(å°åŒ—å®¢é‹)", "æ–°èŠäºŒç«™(é¦–éƒ½å®¢é‹)", "è±¡é ­åŸ”åœè»Šå ´(å°åŒ—å®¢é‹)", "æ–°åº—ç«™(å°åŒ—å®¢é‹)", "æ°‘ç”Ÿç«™"],
    "FuhobusInc": ["å¤§æ­¦å´™ç«™"],
    "Kuang-HuaBus": ["æ±æ¹–ç«™", "åŒ—å³°ç«™", "åŒ—å£«ç§‘ç«™", "å¤©æ±ç«™", "å¤©è¥¿ç«™", "æµ·å°ˆç«™", "æ•…å®®ç«™", "éºŸå…‰ç«™", "ä¸­å’Œç«™", "åŸºéš†ç«™(åŸºéš†å®¢é‹)"],
    "RoyalBus": ["åŠ æŠ•ç«™"],
    "TaoyuanBus": ["ä¸­å£¢å…¬è»Šç«™", "è§€éŸ³ç«™", "å¤§æºªç«™", "ä¸­å£¢ç«™", "ç«¹åœç«™", "é¾æ½­ç«™", "å¤§åœ’ç«™", "ä¸‰å³½ç«™", "æ¡ƒåœ’å…¬è»Šç«™", "ä¸­å£¢ç«™"],
    "ZhongliBus": ["ä¸­å£¢ç«™", "æ¡ƒåœ’ç«™"],
    "YatungBus": ["æ–°åº—ç«™", "æ–°ç«¹ç«™"],
    "KamalanBus": ["å¤§åœ’ç«™", "ç¾…æ±ç«™"],
    "YosemiteBus": ["æ–°ç«¹ç«™"],
    "taisibus": ["æ–—å…­ç«™", "è™å°¾è¥¿ç«™", "åŒ—æ¸¯ç«™", "è¥¿èºç«™", "æ–—å—ç«™", "ç«¹å±±ç«™"],
    "NANTOUBU": ["å°ä¸­å¹²åŸç«™", "é«˜éµå°ä¸­ç«™", "è‰å±¯æœå‹™è™•", "åŸ”é‡Œè½‰é‹ç«™", "æ—¥æœˆæ½­ç«™"],
    "GreenTransit": ["ä¸­èˆˆç«™"],
    "AlishanBus": ["å¤ªä¿ç«™"],
    "YunlinBus": ["é›²ç§‘å¤§ç«™"],
    "SOLARbus": ["æ–—å…­ç«™", "è¥¿èºç«™", "éº¥å¯®ç«™"],
    "ChiayiBus": ["ç¸½å…¬å¸", "ä¸­å±±ç¸½ç«™", "åŒ—æ¸¯ç«™", "æœ´å­ç«™"],
    "TainanBus": ["é ‚æ±ç«™", "èŒ„è£ç«™", "ä»å¾·è½‰é‹ç«™ï¼ˆèƒ¸è…”ç—…é™¢æ—)", "å¡­å—é‡Œ", "ä¸‹é¯¤é¯“ç«™"],
    "SinhuaBus": ["å®‰å¹³å·¥æ¥­å€", "è‡ºå—ç«è»Šç«™", "ä½³é‡Œç«™", "æ–°åŒ–ç«™", "éº»è±†ç«™", "ç‰äº•ç«™", "æ¥ è¥¿ç«™"],
    "SingingBus": ["ç¸½å…¬å¸", "æ–°ç‡Ÿç«™", "ç™½æ²³ç«™"],
    "Han-ChengBus": ["é‡‘ç…æ¹–ç«™", "æ–°ç‡Ÿç«™"],
    "GreatCityLifeBus": ["åŠ æ˜Œç«™", "å°æ¸¯ç«™", "å·¦ç‡Ÿå—ç«™", "å‰é®ç«™", "å»ºè»ç«™"],
    "KaohsiungBus": ["ç¸½å…¬å¸", "æ—åœ’ç«™", "å°ç‰çƒç«™", "é³³å±±ç«™", "å¤§é †ç«™", "å»ºåœ‹ç«™", "æ¥ æ¢“ç«™", "å²¡å±±ç«™", "èŒ„è£ç«™", "æ——å±±è½‰é‹ç«™", "æ——å±±åŒ—ç«™", "ç¾æ¿ƒç«™", "å…­é¾œç«™", "ç”²ä»™ç«™", "å°å—ç«™", "æ°´é–€è½‰é‹ç«™"],
    "SouthTaiwanBus": ["é«˜é›„ç«™"],
    "E-DaBus": ["ç¾©å¤§ç«™"],
    "PingTungBus": ["å±æ±ç«™", "å±ç§‘å¤§", "é‡Œæ¸¯ç«™", "é«˜æ¨¹ç«™", "ç¾æ¿ƒç«™", "æ°´é–€ç«™", "é¹½åŸ”ç«™", "æ½®å·ç«™", "æ±æ¸¯ç«™", "æ‹å¯®ç«™", "æ†æ˜¥ç«™", "å…±ç‡Ÿä¸­å¿ƒ"],
    "TarokoBus": ["æ±è¯å¤§å­¸ç«™",],
    "PuyumaTransportation": ["æ›´ç”Ÿè·¯è»Šå» "],
    "phpto": ["é¦¬å…¬ç¸½ç«™"],
    "matsuebus": ["åŒ—ç«¿", "å—ç«¿", "æ±è’", "è¥¿è’", "æ±å¼•"],
    "Kinmen": ["é‡‘åŸç«™(é‡‘åŸåœè»Šå ´)", "å±±å¤–ç«™(å»ºè¯åœè»Šå ´)", "æ²™ç¾ç«™", "çƒˆå¶¼ç«™"]
};

// --- 3. åˆå§‹åŒ–èˆ‡å·¥å…·å‡½å¼ ---

// é¡¯ç¤º/éš±è— Loading
function toggleLoading(show) {
    document.getElementById("loadingOverlay").style.display = show ? "flex" : "none";
}

// é¡¯ç¤º Toast é€šçŸ¥ (SweetAlert2)
const Toast = Swal.mixin({
    toast: true, position: 'top-end', showConfirmButton: false, timer: 3000,
    timerProgressBar: true, didOpen: (toast) => {
        toast.addEventListener('mouseenter', Swal.stopTimer)
        toast.addEventListener('mouseleave', Swal.resumeTimer)
    }
});

function showToast(icon, title) {
    Toast.fire({ icon: icon, title: title });
}

// è£ç½®åµæ¸¬
function detectDevice() {
    const width = window.innerWidth;
    const tag = document.getElementById("deviceTag");
    if (width < 768) { tag.textContent = "ğŸ“± æ‰‹æ©Ÿç‰ˆ"; tag.style.backgroundColor = "#10b981"; }
    else { tag.textContent = "ğŸ’» é›»è…¦ç‰ˆ"; tag.style.backgroundColor = "#3b82f6"; }
}
window.addEventListener('resize', detectDevice);
detectDevice();

// åˆå§‹åŒ– Choices.js
document.addEventListener('DOMContentLoaded', function() {
    const opSelect = document.getElementById('operator');
    
    operatorChoiceInstance = new Choices(opSelect, {
        searchEnabled: true,
        shouldSort: false,      // ğŸ›‘ ç¦æ­¢è‡ªå‹•æ’åº
        shouldSortItems: false, // ğŸ›‘ ç¢ºä¿å…§å®¹é¸é …ä¹Ÿä¸æœƒè¢«é‡æ–°æ’åº
        itemSelectText: '',
        placeholder: true,
        placeholderValue: 'è«‹æœå°‹æˆ–é¸æ“‡å®¢é‹æ¥­è€…'
    });

    // ç›£è½ Choices.js çš„æ”¹è®Šäº‹ä»¶ä¾†é€£å‹•è»Šå» 
    opSelect.addEventListener('change', function(event) {
        updateManufacturer(event.target.value);
    });

    // è»Šè™Ÿè‡ªå‹•è½‰å¤§å¯«
    document.getElementById("busNumber").addEventListener("input", function() {
        this.value = this.value.toUpperCase();
    });
    
    updateTimestamp();
});

function updateManufacturer(operatorValue) {
    const manuSelect = document.getElementById("manufacturer");
    manuSelect.innerHTML = "";
    
    const stations = operatorToManufacturer[operatorValue];
    
    if (stations) {
        const def = document.createElement("option");
        def.value = ""; def.textContent = "--- è«‹é¸æ“‡è»Šå» /å ´ç«™ (é¸å¡«) ---"; def.selected = true;
        manuSelect.appendChild(def);
        stations.forEach(m => {
            const op = document.createElement("option");
            op.value = m; op.textContent = m;
            manuSelect.appendChild(op);
        });
    } else {
        const op = document.createElement("option");
        op.value = ""; op.textContent = "ç„¡å°æ‡‰è»Šå» è³‡æ–™ (å¯ç•¥é)";
        manuSelect.appendChild(op);
    }
}

function updateTimestamp() {
    const now = new Date();
    // ä¿®æ”¹è™•ï¼šè¨­å®šæ™‚é–“æ ¼å¼ç‚º YYYY/MM/DD ä¸ŠåˆH:MM:SS
    const timeString = now.toLocaleString('zh-TW', {
        year: 'numeric', month: '2-digit', day: '2-digit',
        hour: 'numeric', minute: '2-digit', second: '2-digit',
        hour12: true
    });
    document.getElementById("timestamp").value = timeString;
    
    const w = ["æ—¥","ä¸€","äºŒ","ä¸‰","å››","äº”","å…­"];
    document.getElementById("weekday").value = "æ˜ŸæœŸ" + w[now.getDay()];
}

// --- 4. ä½¿ç”¨è€…èªè­‰ ---
auth.onAuthStateChanged(user => {
    if (user) {
        document.getElementById("userEmail").textContent = user.email;
        document.getElementById("loginForm").style.display = "none";
        document.getElementById("userInfo").style.display = "block";
        loadRecords(user.uid);
    } else {
        document.getElementById("loginForm").style.display = "block";
        document.getElementById("userInfo").style.display = "none";
        document.getElementById("recordTable").querySelector("tbody").innerHTML = "";
        globalRecords = [];
    }
});

async function login() {
    const e = document.getElementById("email").value, p = document.getElementById("password").value;
    if(!e || !p) return showToast('warning', 'è«‹è¼¸å…¥å¸³è™Ÿå¯†ç¢¼');
    toggleLoading(true);
    try { await auth.signInWithEmailAndPassword(e,p); showToast('success', 'ç™»å…¥æˆåŠŸ'); }
    catch(err){ showToast('error', err.message); }
    finally { toggleLoading(false); }
}

async function signup() {
    const e = document.getElementById("email").value, p = document.getElementById("password").value;
    if(p.length<6) return showToast('warning', 'å¯†ç¢¼éœ€6ä½ä»¥ä¸Š');
    toggleLoading(true);
    try { await auth.createUserWithEmailAndPassword(e,p); showToast('success', 'è¨»å†ŠæˆåŠŸ'); }
    catch(err){ showToast('error', err.message); }
    finally { toggleLoading(false); }
}

function logout() { auth.signOut(); showToast('info', 'å·²ç™»å‡º'); }

// --- 5. è³‡æ–™æ“ä½œ CRUD ---

// å„²å­˜è³‡æ–™
async function saveData() {
    const user = auth.currentUser; 
    if(!user) return showToast('warning', 'è«‹å…ˆç™»å…¥');
    
    const op = document.getElementById("operator").value;
    const type = document.getElementById("busType").value;
    const num = document.getElementById("busNumber").value;
    const route = document.getElementById("routeCode").value;
    const manu = document.getElementById("manufacturer").value;
    const note = document.getElementById("note").value;

    if(!op || !type || num.trim()==="") return showToast('warning', 'è«‹å¡«å¯«å®¢é‹ã€è»Šå‹èˆ‡è»Šè™Ÿ');

    toggleLoading(true);
    try {
        const data = {
            userId: user.uid,
            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
            weekday: document.getElementById("weekday").value,
            operator: op, manufacturer: manu, routeCode: route,
            busNumber: num.toUpperCase(), busType: type, note: note
        };
        
        await db.collection("busRecords").add(data);
        showToast('success', 'ç´€éŒ„å·²å„²å­˜');
        resetForm();
    } catch(e) { console.error(e); showToast('error', 'å„²å­˜å¤±æ•—'); }
    finally { toggleLoading(false); }
}

// è¼‰å…¥ç·¨è¼¯
function loadToForm(id, r) {
    editDocId = id;
    
    operatorChoiceInstance.setChoiceByValue(r.operator);
    setTimeout(() => document.getElementById("manufacturer").value = r.manufacturer, 100);
    
    document.getElementById("routeCode").value = r.routeCode;
    document.getElementById("busNumber").value = r.busNumber;
    document.getElementById("busType").value = r.busType;
    document.getElementById("note").value = r.note;
    
    // UI åˆ‡æ›
    document.getElementById("btnEdit").style.display = "inline-flex";
    document.getElementById("btnDelete").style.display = "inline-flex";
    document.getElementById("btnCancel").style.display = "inline-flex";
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

function cancelEdit() {
    resetForm();
    showToast('info', 'å·²å–æ¶ˆç·¨è¼¯');
}

async function saveEdit() {
    if(!editDocId) return;
    toggleLoading(true);
    try {
        await db.collection("busRecords").doc(editDocId).update({
            operator: document.getElementById("operator").value,
            manufacturer: document.getElementById("manufacturer").value,
            routeCode: document.getElementById("routeCode").value,
            busNumber: document.getElementById("busNumber").value.toUpperCase(),
            busType: document.getElementById("busType").value,
            note: document.getElementById("note").value
        });
        showToast('success', 'ä¿®æ”¹æˆåŠŸ');
        resetForm();
    } catch(e) { showToast('error', 'ä¿®æ”¹å¤±æ•—'); }
    finally { toggleLoading(false); }
}

async function deleteRecord() {
    if(!editDocId) return;
    
    const result = await Swal.fire({
        title: 'ç¢ºå®šåˆªé™¤?', text: "é€™ç­†è³‡æ–™å°‡ç„¡æ³•å¾©åŸ", icon: 'warning',
        showCancelButton: true, confirmButtonColor: '#d33', cancelButtonColor: '#3085d6', confirmButtonText: 'æ˜¯çš„, åˆªé™¤!'
    });

    if (result.isConfirmed) {
        toggleLoading(true);
        try {
            await db.collection("busRecords").doc(editDocId).delete();
            showToast('success', 'å·²åˆªé™¤');
            resetForm();
        } catch(e){ showToast('error', 'åˆªé™¤å¤±æ•—'); }
        finally { toggleLoading(false); }
    }
}

async function deleteAllRecords() {
    const user = auth.currentUser; if(!user) return;
    const result = await Swal.fire({
        title: 'âš ï¸ å±éšªæ“ä½œ', text: "ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰ç´€éŒ„å—ï¼Ÿ", icon: 'warning',
        showCancelButton: true, confirmButtonColor: '#d33', confirmButtonText: 'å…¨éƒ¨æ¸…ç©º!'
    });

    if (result.isConfirmed) {
        toggleLoading(true);
        try {
            const q = await db.collection("busRecords").where("userId","==",user.uid).get();
            const batch = db.batch();
            q.forEach(doc => batch.delete(doc.ref));
            await batch.commit();
            showToast('success', 'è³‡æ–™åº«å·²æ¸…ç©º');
            resetForm();
        } catch(e){ showToast('error', 'æ¸…ç©ºå¤±æ•—'); }
        finally { toggleLoading(false); }
    }
}

function resetForm() {
    document.getElementById("surveyForm").reset();
    operatorChoiceInstance.setChoiceByValue(""); // é‡ç½® Choices
    editDocId = null;
    document.getElementById("btnEdit").style.display = "none";
    document.getElementById("btnDelete").style.display = "none";
    document.getElementById("btnCancel").style.display = "none";
    updateTimestamp();
}

// è¼‰å…¥è³‡æ–™åˆ—è¡¨
function loadRecords(uid) {
    db.collection("busRecords").where("userId","==",uid).orderBy("timestamp","desc").onSnapshot(snapshot => {
        const tbody = document.getElementById("recordTable").querySelector("tbody");
        tbody.innerHTML = "";
        globalRecords = [];
        
        snapshot.docs.forEach(doc => {
            const r = doc.data();
            globalRecords.push(r);
            const row = tbody.insertRow(-1);
            
            // é¡¯ç¤ºåç¨±è™•ç†
            const opName = OPERATOR_NAMES[r.operator] || r.operator;
            // ä¿®æ”¹è™•ï¼šåˆ—è¡¨é¡¯ç¤ºæ ¼å¼
            const ts = r.timestamp ? r.timestamp.toDate().toLocaleString('zh-TW', {
                year: 'numeric', month: '2-digit', day: '2-digit',
                hour: 'numeric', minute: '2-digit', second: '2-digit',
                hour12: true
            }) : 'N/A';
            
            // å°‡è»Šå‹è½‰ç‚ºä¸­æ–‡
            const busTypeName = BUSTYPE_NAMES[r.busType] || r.busType;
            
            row.innerHTML = `
                <td>${ts}</td>
                <td>${r.weekday}</td>
                <td>${opName}</td>
                <td>${r.manufacturer || '-'}</td>
                <td>${r.routeCode || '-'}</td>
                <td><b>${r.busNumber}</b></td>
                <td>${busTypeName}</td>
                <td style="max-width:150px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${r.note}</td>
            `;
            row.onclick = () => loadToForm(doc.id, r);
        });
    });
}

// --- 6. è¡¨æ ¼æœå°‹åŠŸèƒ½ ---
function filterTable() {
    const input = document.getElementById("tableSearch");
    const filter = input.value.toUpperCase();
    const table = document.getElementById("recordTable");
    const tr = table.getElementsByTagName("tr");

    for (let i = 1; i < tr.length; i++) {
        let visible = false;
        const tds = tr[i].getElementsByTagName("td");
        for (let j = 0; j < tds.length; j++) {
            if (tds[j] && tds[j].textContent.toUpperCase().indexOf(filter) > -1) {
                visible = true; break;
            }
        }
        tr[i].style.display = visible ? "" : "none";
    }
}

// --- 7. åŒ¯å‡º/åŒ¯å…¥/çµ±è¨ˆ ---
function exportCSV() {
    if(globalRecords.length===0) return showToast('info', 'ç„¡è³‡æ–™å¯åŒ¯å‡º');
    const data = globalRecords.map(r => ({
        // ä¿®æ”¹è™•ï¼šåŒ¯å‡ºæ ¼å¼
        "æ™‚é–“": r.timestamp ? r.timestamp.toDate().toLocaleString('zh-TW', {
            year: 'numeric', month: '2-digit', day: '2-digit',
            hour: 'numeric', minute: '2-digit', second: '2-digit',
            hour12: true
        }) : "",
        "æ˜ŸæœŸ": r.weekday, "å®¢é‹": r.operator, "è»Šå» ": r.manufacturer,
        "è·¯ç·š": r.routeCode, "è»Šè™Ÿ": r.busNumber, "è»Šå‹": BUSTYPE_NAMES[r.busType]||r.busType, "å‚™è¨»": r.note
    }));
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.json_to_sheet(data);
    XLSX.utils.book_append_sheet(wb, ws, "Records");
    saveAs(new Blob([XLSX.write(wb,{bookType:'csv',type:'array'})],{type:'text/csv;charset=utf-8;'}), "bus_record.csv");
}

function handleFileSelect(input) {
    const f = input.files[0]; if(!f) return;
    const r = new FileReader();
    r.onload = e => {
        const wb = XLSX.read(new Uint8Array(e.target.result), {type:'array'});
        const data = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
        if(confirm(`åŒ¯å…¥ ${data.length} ç­†è³‡æ–™?`)) processImport(data);
        input.value = "";
    };
    r.readAsArrayBuffer(f);
}

// --- æ–°å¢ï¼šæ—¥æœŸè§£æå‡½å¼ ---
function parseImportTime(val) {
    if (!val) return new Date(); // ç„¡å€¼å‰‡å›å‚³ç¾åœ¨
    if (val instanceof Date) return val; // å·²ç¶“æ˜¯ Date ç‰©ä»¶
    
    // è™•ç† Excel æ•¸å­—åºåˆ—å€¼ (ä¾‹å¦‚ 45200.123)
    if (typeof val === 'number') {
        // Excel base date is 1899-12-30. JS is 1970-01-01. Diff is 25569 days.
        return new Date(Math.round((val - 25569) * 86400 * 1000));
    }
    
    if (typeof val === 'string') {
        // å˜—è©¦è™•ç† "2025/12/13 ä¸Šåˆ8:57:30" é€™ç¨®ä¸­æ–‡æ ¼å¼
        if (val.includes("ä¸Šåˆ") || val.includes("ä¸‹åˆ")) {
            // Regex è§£æ YYYY/MM/DD (ä¸Šåˆ/ä¸‹åˆ)H:MM:SS
            const parts = val.match(/(\d+)\/(\d+)\/(\d+)\s+(ä¸Šåˆ|ä¸‹åˆ)(\d+):(\d+):(\d+)/);
            if (parts) {
               let [_, y, m, d, ap, h, min, s] = parts;
               h = parseInt(h);
               if (ap === "ä¸‹åˆ" && h < 12) h += 12;
               if (ap === "ä¸Šåˆ" && h === 12) h = 0;
               return new Date(y, m-1, d, h, min, s);
            }
        }
        // å˜—è©¦æ¨™æº–æ ¼å¼ (ISO or standard string)
        const d = new Date(val);
        if (!isNaN(d.getTime())) return d;
    }
    return new Date(); // è§£æå¤±æ•—é è¨­å›å‚³ç¾åœ¨
}

async function processImport(data) {
    const user = auth.currentUser; if(!user) return;
    toggleLoading(true);
    let count = 0;
    try {
        const batchSize = 500; // Firestore batch limit
        let batch = db.batch();
        
        for(let i=0; i<data.length; i++) {
            const r = data[i];
            
            // ä¿®æ­£ï¼šä½¿ç”¨è§£æå‡½å¼è™•ç†æ™‚é–“ï¼Œè€Œéç›´æ¥ç”¨ now()
            const importTime = parseImportTime(r['æ™‚é–“'] || r['æ™‚é–“æˆ³è¨˜']);
            const w = ["æ—¥","ä¸€","äºŒ","ä¸‰","å››","äº”","å…­"];
            const weekday = "æ˜ŸæœŸ" + w[importTime.getDay()];

            const docRef = db.collection("busRecords").doc();
            batch.set(docRef, {
                userId: user.uid,
                timestamp: firebase.firestore.Timestamp.fromDate(importTime),
                weekday: weekday, // è‡ªå‹•é‡ç®—æ˜ŸæœŸ
                operator: r['å®¢é‹æ¥­è€…'] || r['å®¢é‹'] || "Other",
                manufacturer: r['è»Šå» '] || "",
                routeCode: String(r['è·¯ç·šç¢¼'] || r['è·¯ç·š'] || ""),
                busNumber: String(r['è»Šè™Ÿ'] || "UNKNOWN").toUpperCase(),
                busType: r['è»Šå‹'] || "Other",
                note: r['å‚™è¨»'] || "æ‰¹æ¬¡åŒ¯å…¥"
            });
            count++;
            if(count % batchSize === 0) { await batch.commit(); batch = db.batch(); }
        }
        if(count % batchSize !== 0) await batch.commit();
        showToast('success', `æˆåŠŸåŒ¯å…¥ ${count} ç­†è³‡æ–™`);
    } catch(e) { console.error(e); showToast('error', 'åŒ¯å…¥ç™¼ç”ŸéŒ¯èª¤'); }
    finally { toggleLoading(false); }
}

// é¡¯ç¤ºçµ±è¨ˆ (ä½¿ç”¨ Chart.js)
function showStats() {
    if(globalRecords.length===0) return showToast('info', 'ç›®å‰æ²’æœ‰è³‡æ–™');
    document.getElementById("statsModal").style.display = "block";
    
    // è¨ˆç®—æ•¸æ“š
    document.getElementById("statTotal").textContent = globalRecords.length;
    document.getElementById("statUnique").textContent = new Set(globalRecords.map(r=>r.busNumber)).size;

    const opCounts = {};
    const routeCounts = {};
    
    globalRecords.forEach(r => {
        const op = OPERATOR_NAMES[r.operator] || r.operator;
        opCounts[op] = (opCounts[op] || 0) + 1;
        
        const rt = r.routeCode || "æœªå¡«å¯«";
        routeCounts[rt] = (routeCounts[rt] || 0) + 1;
    });

    // ç¹ªè£½åœ–è¡¨
    renderChart('operatorChart', 'å®¢é‹æ­ä¹˜åˆ†ä½ˆ', opCounts, 'pie');
    renderChart('routeChart', 'æœ€å¸¸æ­çš„è·¯ç·š (Top 10)', routeCounts, 'bar');
}

function renderChart(canvasId, label, dataObj, type) {
    const ctx = document.getElementById(canvasId).getContext('2d');
    
    // æ’åºä¸¦å– Top 10
    const sortedData = Object.entries(dataObj).sort((a,b)=>b[1]-a[1]).slice(0, 10);
    const labels = sortedData.map(d => d[0]);
    const values = sortedData.map(d => d[1]);

    if(charts[canvasId]) charts[canvasId].destroy(); // éŠ·æ¯€èˆŠåœ–è¡¨

    charts[canvasId] = new Chart(ctx, {
        type: type,
        data: {
            labels: labels,
            datasets: [{
                label: 'æ¬¡æ•¸',
                data: values,
                backgroundColor: [
                    '#3b82f6', '#ef4444', '#10b981', '#f59e0b', '#8b5cf6',
                    '#6366f1', '#ec4899', '#14b8a6', '#f97316', '#64748b'
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: { display: true, text: label, font: {size: 16} },
                legend: { display: type === 'pie' } // é•·æ¢åœ–ä¸é¡¯ç¤ºåœ–ä¾‹
            }
        }
    });
}

function closeStats() { document.getElementById("statsModal").style.display="none"; }

// --- æ–°å¢ï¼šè»Šè™Ÿçµ±è¨ˆåˆ—è¡¨ JS é‚è¼¯ ---
function showBusStats() {
    if(globalRecords.length===0) return showToast('info', 'ç›®å‰æ²’æœ‰è³‡æ–™');
    document.getElementById("busStatsModal").style.display = "block";

    const busMap = {};
    globalRecords.forEach(r => {
        const num = r.busNumber;
        if(!busMap[num]) {
            busMap[num] = {
                count: 0,
                operator: OPERATOR_NAMES[r.operator] || r.operator
            };
        }
        busMap[num].count++;
    });

    const tbody = document.getElementById("busListBody");
    tbody.innerHTML = "";
    
    // Sort A-Z
    Object.keys(busMap).sort().forEach(num => {
        const item = busMap[num];
        const row = `<tr>
            <td><b>${num}</b></td>
            <td>${item.count}</td>
            <td>${item.operator}</td>
        </tr>`;
        tbody.innerHTML += row;
    });
}
function closeBusStats() { document.getElementById("busStatsModal").style.display = "none"; }

window.onclick = e => { if(e.target.className==="modal") e.target.style.display="none"; }

</script>
</body>
</html>
