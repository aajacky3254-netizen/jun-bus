<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>æ¯æ—¥æ­ä¹˜èª¿æŸ¥</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <style>
    body {
      font-family: "Microsoft JhengHei", Arial, sans-serif;
      background-color: #f9fafb;
      margin: 20px;
      touch-action: manipulation;
    }

    h1 {
      color: #2563eb;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px;
    }

    /* è£ç½®æ¨™ç±¤æ¨£å¼ */
    #deviceTag {
        font-size: 0.6em;
        padding: 5px 10px;
        border-radius: 15px;
        color: white;
        background-color: #6b7280;
        vertical-align: middle;
    }

    .form-group {
      margin-bottom: 15px;
    }

    label {
      font-weight: 600;
      color: #374151;
      display: block;
      margin-bottom: 5px;
    }

    input, select, textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      transition: border-color 0.2s;
      box-sizing: border-box; 
      font-size: 16px; /* é˜²æ­¢æ‰‹æ©Ÿç‰ˆè‡ªå‹•ç¸®æ”¾ */
    }

    /* --- é‡é»ä¿®æ”¹ï¼šåŠ å¤§å‚™è¨»æ¬„ --- */
    textarea {
        min-height: 120px; /* è¨­å®šæœ€å°é«˜åº¦ï¼Œç´„ 4 è¡Œé«˜ */
        resize: vertical;  /* å…è¨±ä½¿ç”¨è€…å‚ç›´æ‹‰å¤§ */
    }

    input:focus, select:focus, textarea:focus {
      border-color: #2563eb;
      outline: none;
    }

    /* --- æŒ‰éˆ•é€šç”¨æ¨£å¼ (åŠ å¼·ç‰ˆ) --- */
    button {
      color: white !important; /* å¼·åˆ¶æ–‡å­—ç™½è‰² */
      border: none;
      border-radius: 8px;
      padding: 12px 16px;
      margin-right: 8px;
      margin-bottom: 10px;
      cursor: pointer;
      font-size: 15px;
      font-weight: 500;
      transition: all 0.2s;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1); /* åŠ å…¥é™°å½±å¢åŠ ç«‹é«”æ„Ÿ */
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 5px; /* åœ–ç¤ºèˆ‡æ–‡å­—çš„é–“è· */
    }
    
    button:hover {
        filter: brightness(90%);
        transform: translateY(-1px); /* æ»‘é¼ ç§»éå»å¾®å¾®æµ®èµ· */
        box-shadow: 0 4px 6px rgba(0,0,0,0.15);
    }
    
    button:active {
        transform: translateY(0);
    }

    /* --- é‡é»ä¿®æ”¹ï¼šæŒ‰éˆ•é¡è‰² (å¼·åˆ¶å¥—ç”¨) --- */
    .btn-blue { background-color: #2563eb !important; }   /* ä¸€èˆ¬æ“ä½œ */
    .btn-orange { background-color: #f97316 !important; } /* å„²å­˜ç´€éŒ„ (æ©˜è‰²) */
    .btn-red { background-color: #dc2626 !important; }    /* åˆªé™¤ (ç´…è‰²) */
    .btn-purple { background-color: #7c3aed !important; } /* çµ±è¨ˆ (ç´«è‰²) */
    .btn-green { background-color: #059669 !important; }  /* è»Šè™Ÿ/åŒ¯å…¥ (ç¶ è‰²) */

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }

    table th, table td {
      padding: 10px;
      border: 1px solid #d1d5db;
      text-align: center;
      font-size: 14px;
    }

    table tbody tr:nth-child(even) {
      background-color: #f3f4f6;
    }
    
    .table-responsive {
        width: 100%;
        overflow-x: auto;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    /* --- éŸ¿æ‡‰å¼ä½ˆå±€ --- */
    .form-container {
        display: block;
    }
    .button-group {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }
    .button-group button {
        width: 100%;
        margin-right: 0;
    }

    @media (min-width: 768px) {
        .form-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .full-width {
            grid-column: span 2;
        }
        .button-group {
            flex-direction: row;
            flex-wrap: wrap;
            align-items: center;
        }
        .button-group button {
            width: auto;
            margin-right: 10px;
        }
    }

    /* --- Modal æ¨£å¼ --- */
    .modal {
        display: none; 
        position: fixed; 
        z-index: 1000; 
        left: 0;
        top: 0;
        width: 100%; 
        height: 100%; 
        overflow: auto; 
        background-color: rgba(0,0,0,0.5); 
        backdrop-filter: blur(2px); /* èƒŒæ™¯æ¨¡ç³Šæ•ˆæœ */
    }

    .modal-content {
        background-color: #fefefe;
        margin: 5% auto; 
        padding: 25px;
        border: 1px solid #888;
        width: 90%; 
        max-width: 600px;
        border-radius: 12px;
        box-shadow: 0 10px 25px rgba(0,0,0,0.2);
    }
    .modal-content.wide-modal { max-width: 800px; }
    .close-btn { float: right; font-size: 28px; cursor: pointer; color: #6b7280; }
    .close-btn:hover { color: #000; }
    
    .stat-row { display: flex; margin-bottom: 12px; align-items: center; }
    .stat-label { width: 120px; text-align: right; margin-right: 12px; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-weight: 500; }
    .stat-bar-container { flex-grow: 1; background: #e5e7eb; height: 24px; border-radius: 12px; position: relative; overflow: hidden; }
    .stat-bar { background: linear-gradient(90deg, #3b82f6, #60a5fa); height: 100%; border-radius: 12px 0 0 12px; transition: width 0.5s ease-out; }
    .stat-value { position: absolute; right: 8px; top: 0; font-size: 13px; line-height: 24px; color: #374151; font-weight: bold; }
    
    .summary-cards { display: flex; justify-content: space-between; margin-bottom: 25px; gap: 15px; }
    .summary-card { background: #eff6ff; padding: 20px; border-radius: 12px; width: 48%; text-align: center; box-shadow: 0 2px 4px rgba(37, 99, 235, 0.1); }
    .summary-number { font-size: 28px; font-weight: bold; color: #2563eb; margin-top: 5px; }
    .bus-list-table th { background: #e5e7eb; position: sticky; top: 0; }

  </style>
</head>
<body>

  <h1>
      æ¯æ—¥æ­ä¹˜èª¿æŸ¥
      <span id="deviceTag">åµæ¸¬ä¸­...</span>
  </h1>

  <div id="authSection" style="margin-bottom: 30px; padding: 20px; border: 1px solid #e5e7eb; border-radius: 12px; background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
    <h2 style="margin-top: 0; color: #374151;">ä½¿ç”¨è€…èªè­‰ (è·¨è£ç½®åŒæ­¥)</h2>
    <div id="loginForm">
      <input type="email" id="email" placeholder="Email" style="margin-bottom: 10px;">
      <input type="password" id="password" placeholder="å¯†ç¢¼" style="margin-bottom: 15px;">
      <div class="button-group" style="flex-direction: row;">
        <button type="button" class="btn-blue" onclick="login()">ç™»å…¥</button>
        <button type="button" class="btn-blue" onclick="signup()">è¨»å†Š</button>
      </div>
    </div>
    <div id="userInfo" style="display:none;">
      <p style="font-size: 1.1em;">ç›®å‰ç™»å…¥ï¼š<span id="userEmail" style="font-weight: bold; color: #2563eb;"></span></p>
      <button type="button" class="btn-blue" onclick="logout()">ç™»å‡º</button>
    </div>
  </div>

  <form id="surveyForm">
    <div class="form-container">
        <div class="form-group">
            <label for="timestamp">æ™‚é–“æˆ³è¨˜</label>
            <input type="text" id="timestamp" readonly style="background-color: #f3f4f6;"> 
        </div>

        <div class="form-group">
            <label for="weekday">æ˜ŸæœŸ</label>
            <input type="text" id="weekday" readonly style="background-color: #f3f4f6;">
        </div>

        <div class="form-group">
            <label for="operator">å®¢é‹æ¥­è€…</label>
            <select id="operator" name="operator" required>
                <option value="" disabled selected>--- è«‹é¸æ“‡å®¢é‹æ¥­è€… ---</option>
                <optgroup label="åŸºéš†/æ–°åŒ—/è‡ºåŒ—">
                    <option value="KeelungCity">åŸºéš†å¸‚å…¬è»Šè™•</option>
                    <option value="KeelungBus">åŸºéš†å®¢é‹</option>
                    <option value="CapitalBus">é¦–éƒ½å®¢é‹</option>
                    <option value="TaipeiBus">è‡ºåŒ—å®¢é‹</option>
                    <option value="ZhinanBus">æŒ‡å—å®¢é‹</option>
                    <option value="NewTaipeiBus">æ–°åŒ—å®¢é‹</option>
                    <option value="SanChung">ä¸‰é‡å®¢é‹</option>
                    <option value="KuoKuang">åœ‹å…‰å®¢é‹</option>
                    <option value="MetropolitanTransport">å¤§éƒ½æœƒå®¢é‹</option>
                    <option value="ZhongxingBus">ä¸­èˆˆå·´å£«</option>
                    <option value="Kuang-HuaBus">å…‰è¯å·´å£«</option>
                    <option value="DaNan">å¤§å—æ±½è»Š</option>
                    <option value="HsinBus">æ¬£æ¬£å®¢é‹</option>
                    <option value="SindianBus">æ–°åº—å®¢é‹</option>
                    <option value="TamshuiBus">æ·¡æ°´å®¢é‹</option>
                    <option value="TaoyuanBus">æ¡ƒåœ’å®¢é‹</option>
                    <option value="FuhobusInc">ç¦å’Œå®¢é‹</option>
                    <option value="RoyalBus">çš‡å®¶å®¢é‹</option>
                    <option value="howtai">è±ªæ³°å®¢é‹</option>
                    <option value="southeastBus">æ±å—å®¢é‹</option>
                    <option value="CitiAirBus">å¤§æœ‰å·´å£«</option>
                </optgroup>
                <optgroup label="æ¡ƒåœ’">
                    <option value="TaoyuanBus">æ¡ƒåœ’å®¢é‹</option>
                    <option value="ZhongliBus">ä¸­å£¢å®¢é‹</option>
                    <option value="HsinchuBus">æ–°ç«¹å®¢é‹</option>
                    <option value="YatungBus">äºé€šå®¢é‹</option>
                    <option value="UnitedBus">çµ±è¯å®¢é‹</option>
                    <option value="SanChung">ä¸‰é‡å®¢é‹</option>
                    <option value="ZhinanBus">æŒ‡å—å®¢é‹</option>
                    <option value="ChampionTransportation">é‡‘å°å®¢é‹</option>
                </optgroup>
                 <optgroup label="æ–°ç«¹/è‹—æ —">
                  <option value="HsinchuBus">æ–°ç«¹å®¢é‹</option>
                  <option value="KuoKuang">åœ‹å…‰å®¢é‹</option>
                  <option value="ChampionTransportation">é‡‘ç‰Œå®¢é‹</option>
                  <option value="YosemiteBus">ç§‘æŠ€ä¹‹æ˜Ÿ</option>
                  <option value="MiaoLi">è‹—æ —å®¢é‹</option>
                  <option value="Jet-ChenBus">æ·ä¹˜å®¢é‹</option>
                  <option value="Yi-JetTechIntegration">äº¦æ·ç§‘éš›</option>
                  <option value="FengyuanBus">è±åŸå®¢é‹</option>
                </optgroup>
                <optgroup label="è‡ºä¸­å¸‚å„æ¥­è€…">
                  <option value="TaichungBus">è‡ºä¸­å®¢é‹</option>
                  <option value="UnitedBus">çµ±è¯å®¢é‹</option>
                  <option value="GeyaBus">å·¨æ¥­äº¤é€š</option>
                  <option value="ChuanHang">å…¨èˆªå®¢é‹</option>
                  <option value="FengyuanBus">è±åŸå®¢é‹</option>
                  <option value="southeastBus">æ±å—å®¢é‹</option>
                  <option value="MiaoLiBus">è‹—æ —å®¢é‹</option>
                  <option value="UnitedBus1">ä¸­å°ç£å®¢é‹</option>
                  <option value="HO-HSINBus">å’Œæ¬£å®¢é‹</option>
                  <option value="Chung-LuBus">ä¸­é¹¿å®¢é‹</option>
                  <option value="AllDayBus">ç¸½é”å®¢é‹</option>
                  <option value="KuoKuang">åœ‹å…‰å®¢é‹</option>
                  <option value="freego">å»ºæ˜å®¢é‹</option>
                  <option value="RuiyiTransportation">ç¿å¥•äº¤é€š</option>
                </optgroup>
                <optgroup label="å½°åŒ–">
                  <option value="ChanghuaBus">å½°åŒ–å®¢é‹</option>
                  <option value="YuanLinBus">å“¡æ—å®¢é‹</option>
                  <option value="Chung-LuBus">ä¸­é¹¿å®¢é‹</option>
                  <option value="TaichungBus">è‡ºä¸­å®¢é‹</option>
                  <option value="GeyaBus">å·¨æ¥­äº¤é€š</option>
                  <option value="taisibus">å°è¥¿å®¢é‹</option>
                  <option value="UnitedBus">çµ±è¯å®¢é‹</option>
                  <option value="KuoKuang">åœ‹å…‰å®¢é‹</option>
                  <option value="NANTOUBUS">å—æŠ•å®¢é‹</option>
                  <option value="FengyuanBus">è±åŸå®¢é‹</option>
                  <option value="southeastBus">æ±å—å®¢é‹</option>
                  <option value="freego">å»ºæ˜å®¢é‹</option>
                </optgroup>
                <optgroup label="å—æŠ•">
                  <option value="NANTOUBUS">å—æŠ•å®¢é‹</option>
                  <option value="ChanghuaBus">å½°åŒ–å®¢é‹</option>
                  <option value="YuanLinBus">å“¡æ—å®¢é‹</option>
                  <option value="AllDayBus">ç¸½é”å®¢é‹</option>
                  <option value="TaichungBus">è‡ºä¸­å®¢é‹</option>
                  <option value="goto307">æ‰æ—æºªå®¢é‹</option>
                  <option value="GreenTransit">è±æ¦®å®¢é‹</option>
                  <option value="ChuanHang">å…¨èˆªå®¢é‹</option>
                  <option value="UnitedBus">çµ±è¯å®¢é‹</option>
                </optgroup>
                <optgroup label="é›²æ—">
                  <option value="taisibus">å°è¥¿å®¢é‹</option>
                  <option value="YunlinBus">é›²æ—å®¢é‹</option>
                  <option value="SOLARbus">æ—¥çµ±å®¢é‹</option>
                  <option value="ChiayiBus">å˜‰ç¾©å®¢é‹</option>
                </optgroup>
                <optgroup label="å˜‰ç¾©">
                  <option value="ChiayiCountyBus">å˜‰ç¾©ç¸£å…¬è»Šè™•</option>
                  <option value="ChiayiBus">å˜‰ç¾©å®¢é‹</option>
                  <option value="taisibus">å°è¥¿å®¢é‹</option>
                  <option value="YunlinBus">é›²æ—å®¢é‹</option>
                  <option value="AlishanBus">é˜¿é‡Œå±±å®¢é‹</option>
                  <option value="KuoKuang">åœ‹å…‰å®¢é‹</option>
                  <option value="Jet-ChenBus">æ·ä¹˜å®¢é‹</option>
                </optgroup>
                <optgroup label="è‡ºå—">
                  <option value="SinhuaBus">èˆˆå—å®¢é‹</option>
                  <option value="SingingBus">æ–°ç‡Ÿå®¢é‹</option>
                  <option value="TainanBus">åºœåŸå®¢é‹</option>
                  <option value="Han-ChengBus">æ¼¢ç¨‹å®¢é‹</option>
                  <option value="GeyaBus">å·¨æ¥­äº¤é€š</option>
                  <option value="UnitedBus">çµ±è¯å®¢é‹</option>
                  <option value="KaohsiungBus">é«˜é›„å®¢é‹</option>
                  <option value="E-DaBus">ç¾©å¤§å®¢é‹</option>
                </optgroup>
                <optgroup label="é«˜é›„">
                  <option value="KaohsiungBus">é«˜é›„å®¢é‹</option>
                  <option value="SouthTaiwanBus">å—è‡ºç£å®¢é‹</option>
                  <option value="Han-ChengBus">æ¼¢ç¨‹å®¢é‹</option>
                  <option value="GreatCityLifeBus">æ¸¯éƒ½å®¢é‹</option>
                  <option value="E-DaBus">ç¾©å¤§å®¢é‹</option>
                  <option value="UnitedBus">çµ±è¯å®¢é‹</option>
                  <option value="southeastBus">æ±å—å®¢é‹</option>
                </optgroup>
                <optgroup label="å±æ±">
                  <option value="PingTungBus">å±æ±å®¢é‹</option>
                  <option value="KaohsiungBus">é«˜é›„å®¢é‹</option>
                  <option value="Jet-ChenBus">æ·ä¹˜å®¢é‹</option>
                </optgroup>
                <optgroup label="å®œè˜­">
                  <option value="MetropolitanTransport">å¤§éƒ½æœƒå®¢é‹</option>
                  <option value="CapitalBus">é¦–éƒ½å®¢é‹</option>
                  <option value="KamalanBus">è‘›ç‘ªè˜­å®¢é‹</option>
                  <option value="KuoKuang">åœ‹å…‰å®¢é‹</option>
                </optgroup>
                <optgroup label="èŠ±è“®">
                  <option value="TarokoBus">å¤ªé­¯é–£å®¢é‹</option>
                  <option value="hopelandbus">è¯è¯å®¢é‹</option>
                  <option value="UnitedBus">çµ±è¯å®¢é‹</option>
                  <option value="DiingDongBus">é¼æ±å®¢é‹</option>
                  <option value="ShingDongBus">èˆˆæ±å®¢é‹</option>
                </optgroup>
                <optgroup label="å°æ±">
                  <option value="PuyumaTransportation">æ™®æ‚ ç‘ªå®¢é‹</option>
                  <option value="DiingDongBus">é¼æ±å®¢é‹</option>
                  <option value="EasternTopTransportation">æ±å°ç£å®¢é‹</option>
                  <option value="ShingDongBus">èˆˆæ±å®¢é‹</option>
                </optgroup>
                 <optgroup label="é›¢å³¶">
                  <option value="phpto">æ¾æ¹–ç¸£å…¬è»Šè™•</option>
                  <option value="matsuebus">é€£æ±Ÿç¸£å…¬å…±è»Šèˆ¹ç®¡ç†è™•</option>
                  <option value="Kinmen">é‡‘é–€ç¸£å…¬å…±è»Šèˆ¹ç®¡ç†è™•</option>
                </optgroup>
                <optgroup label="åœ‹é“/é•·é€”å®¢é‹">
                  <option value="KuoKuang">åœ‹å…‰å®¢é‹</option>
                  <option value="UnitedBus">çµ±è¯å®¢é‹</option>
                  <option value="CapitalBus">é¦–éƒ½å®¢é‹</option>
                  <option value="HO-HSINBus">å’Œæ¬£å®¢é‹</option>
                  <option value="KamalanBus">è‘›ç‘ªè˜­å®¢é‹</option>
                  <option value="YatungBus">äºé€šå®¢é‹</option>
                  <option value="TailianBus">å°è¯å®¢é‹</option>
                  <option value="KeelungBus">åŸºéš†å®¢é‹</option>
                  <option value="NewTaipeiBus">æ–°åŒ—å®¢é‹</option>
                  <option value="SanChung">ä¸‰é‡å®¢é‹</option>
                  <option value="SindianBus">æ–°åº—å®¢é‹</option>
                  <option value="TaoyuanBus">æ¡ƒåœ’å®¢é‹</option>
                  <option value="HsinchuBus">æ–°ç«¹å®¢é‹</option>
                  <option value="TaichungBus">è‡ºä¸­å®¢é‹</option>
                  <option value="AllDayBus">ç¸½é”å®¢é‹</option>
                  <option value="SinhuaBus">èˆˆå—å®¢é‹</option>
                  <option value="CitiAirBus">å¤§æœ‰å·´å£«</option>
                  <option value="howtai">è±ªæ³°å®¢é‹</option>
                </optgroup>
                <optgroup label="å…¶ä»–">
                <option value="Other">å…¶ä»–æ¥­è€… (è«‹åœ¨å‚™è¨»æ¬„è¨»æ˜)</option>
            </select>
        </div>

        <div class="form-group">
            <label for="manufacturer">è»Šå» </label>
            <select id="manufacturer" name="manufacturer">
                <option value="" selected>--- è«‹å…ˆé¸æ“‡å®¢é‹æ¥­è€… ---</option>
            </select>
        </div>

        <div class="form-group">
            <label>è·¯ç·šè™Ÿç¢¼</label>
            <input type="text" id="routeCode">
        </div>

        <div class="form-group">
            <label>è»Šè™Ÿ</label>
            <input type="text" id="busNumber" required>
        </div>

        <div class="form-group">
            <label>è»Šå‹</label>
            <select id="busType" name="busType" required>
                <option value="" disabled selected>--- è«‹é¸æ“‡è»Šå‹ ---</option>
                <option value="dieselbus">æŸ´æ²¹å·´å£«</option>
                <option value="electricbus">é›»å‹•å·´å£«</option>
                <option value="articulatedbus">é›™ç¯€å·´å£«</option>
                <option value="minibus">å°å‹å·´å£«</option>
                <option value="Freewaybusservice">åœ‹é“å®¢é‹</option>
                <option value="Other">å…¶ä»–</option>
            </select>
        </div>

        <div class="form-group full-width">
            <label>å‚™è¨»</label>
            <textarea id="note"></textarea>
        </div>

        <div class="button-group full-width">
            <button type="button" onclick="saveData()" class="btn-orange">ğŸ’¾ å„²å­˜ç´€éŒ„ ğŸ›ï¸</button>
            <button type="button" onclick="saveEdit()" class="btn-blue">âœï¸ å„²å­˜ä¿®æ”¹</button>
            <button type="button" onclick="deleteRecord()" class="btn-red">ğŸ—‘ï¸ åˆªé™¤ç´€éŒ„</button>
            <input type="file" id="importFile" accept=".xlsx, .xls, .csv" style="display:none" onchange="handleFileSelect(this)">
            <button type="button" onclick="document.getElementById('importFile').click()" class="btn-green">ğŸ“¥ åŒ¯å…¥è³‡æ–™</button>
            <button type="button" onclick="exportCSV()" class="btn-blue">ğŸ“¤ åŒ¯å‡ºè³‡æ–™</button>
            <button type="button" onclick="showStats()" class="btn-purple">ğŸ“Š çµ±è¨ˆè³‡æ–™</button>
            <button type="button" onclick="showBusStats()" class="btn-green">ğŸšŒ è»Šè™Ÿçµ±è¨ˆåˆ—è¡¨</button>
            <button type="button" onclick="deleteAllRecords()" class="btn-red">âš ï¸ å…¨éƒ¨åˆªé™¤</button>
        </div>
    </div>
  </form>

  <h2>ç´€éŒ„æ¸…å–®</h2>
  <div class="table-responsive">
      <table border="1" id="recordTable">
        <thead>
          <tr>
            <th>æ™‚é–“æˆ³è¨˜</th><th>æ˜ŸæœŸ</th><th>å®¢é‹æ¥­è€…</th>
            <th>è»Šå» </th><th>è·¯ç·šç¢¼</th><th>è»Šè™Ÿ</th>
            <th>è»Šå‹</th><th>å‚™è¨»</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
  </div>

  <div id="statsModal" class="modal">
    <div class="modal-content">
      <span class="close-btn" onclick="closeStats()">&times;</span>
      <h2 style="text-align: center; color: #2563eb;">ğŸšŒ æ­ä¹˜çµ±è¨ˆåˆ†æ</h2>
      <div class="summary-cards">
          <div class="summary-card"><div>ç¸½æ­ä¹˜æ¬¡æ•¸</div><div class="summary-number" id="totalRides">0</div></div>
          <div class="summary-card"><div>ä¸é‡è¤‡è»Šè™Ÿ</div><div class="summary-number" id="uniqueBuses">0</div></div>
      </div>
      <div class="stat-section"><h3>ğŸ† æœ€å¸¸æ­çš„å®¢é‹æ¥­è€… (Top 5)</h3><div id="topOperators"></div></div>
      <div class="stat-section"><h3>ğŸ›£ï¸ æœ€å¸¸æ­çš„è·¯ç·š (Top 5)</h3><div id="topRoutes"></div></div>
      <div class="stat-section"><h3>ğŸšŒ æœ€å¸¸æ­åˆ°çš„è»Šè™Ÿ (Top 5)</h3><div id="topBusNumbers"></div></div>
    </div>
  </div>

  <div id="busStatsModal" class="modal">
    <div class="modal-content wide-modal">
      <span class="close-btn" onclick="closeBusStats()">&times;</span>
      <h2 style="text-align: center; color: #059669;">ğŸšŒ è»Šè™Ÿçµ±è¨ˆåˆ—è¡¨</h2>
      <p style="text-align: center; margin-bottom: 20px; color: #666;">ä¾ç…§è»Šè™Ÿæ’åº (A-Z)</p>
      <div class="table-responsive">
          <table class="bus-list-table">
            <thead><tr><th>è»Šè™Ÿ</th><th>æ¬¡æ•¸</th><th>æ‰€å±¬å®¢é‹æ¥­è€…</th></tr></thead>
            <tbody id="busListBody"></tbody>
          </table>
      </div>
    </div>
  </div>

<script>
// --- è£ç½®åµæ¸¬èˆ‡ UI èª¿æ•´ ---
function detectDevice() {
    const ua = navigator.userAgent;
    const width = window.innerWidth;
    const tag = document.getElementById("deviceTag");
    
    // ç°¡å–®çš„åˆ¤æ–·é‚è¼¯
    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(ua);
    const isTablet = /(tablet|ipad|playbook|silk)|(android(?!.*mobi))/i.test(ua);
    
    if (isTablet || (width >= 768 && width < 1024)) {
        tag.textContent = "ğŸ“± å¹³æ¿ (Tablet)";
        tag.style.backgroundColor = "#8b5cf6"; // ç´«è‰²
    } else if (isMobile || width < 768) {
        tag.textContent = "ğŸ“± æ‰‹æ©Ÿ (Mobile)";
        tag.style.backgroundColor = "#10b981"; // ç¶ è‰²
    } else {
        tag.textContent = "ğŸ’» é›»è…¦ (Desktop)";
        tag.style.backgroundColor = "#3b82f6"; // è—è‰²
    }
}

// ç›£è½è¦–çª—å¤§å°æ”¹è®Š (ä¾‹å¦‚æ—‹è½‰è¢å¹•)
window.addEventListener('resize', detectDevice);
// åˆå§‹åŸ·è¡Œ
detectDevice();


// --- 1. Firebase åˆå§‹åŒ–è¨­å®š ---
const firebaseConfig = {
    apiKey: "AIzaSyAKTHlEzkOx8uZWOcfTr8YHZj6-bd74MeE",
    authDomain: "jun-bus.firebaseapp.com",
    projectId: "jun-bus",
    storageBucket: "jun-bus.firebasestorage.app",
    messagingSenderId: "685457601811",
    appId: "1:685457601811:web:02f59887b6895879ac96e6",
    measurementId: "G-HPTP7MMCDV"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

let editDocId = null;
let globalRecords = [];

// --- 2. åç¨±ç¿»è­¯è¡¨èˆ‡è³‡æ–™ ---
const OPERATOR_NAMES = {
    "KeelungCity": "åŸºéš†å¸‚å…¬è»Šè™•", "KeelungBus": "åŸºéš†å®¢é‹", "CapitalBus": "é¦–éƒ½å®¢é‹", "TaipeiBus": "è‡ºåŒ—å®¢é‹",
    "ZhinanBus": "æŒ‡å—å®¢é‹", "NewTaipeiBus": "æ–°åŒ—å®¢é‹", "SanChung": "ä¸‰é‡å®¢é‹", "KuoKuang": "åœ‹å…‰å®¢é‹",
    "MetropolitanTransport": "å¤§éƒ½æœƒå®¢é‹", "ZhongxingBus": "ä¸­èˆˆå·´å£«", "Kuang-HuaBus": "å…‰è¯å·´å£«", "DaNan": "å¤§å—æ±½è»Š",
    "HsinBus": "æ¬£æ¬£å®¢é‹", "SindianBus": "æ–°åº—å®¢é‹", "TamshuiBus": "æ·¡æ°´å®¢é‹", "TaoyuanBus": "æ¡ƒåœ’å®¢é‹",
    "FuhobusInc": "ç¦å’Œå®¢é‹", "RoyalBus": "çš‡å®¶å®¢é‹", "howtai": "è±ªæ³°å®¢é‹", "southeastBus": "æ±å—å®¢é‹",
    "CitiAirBus": "å¤§æœ‰å·´å£«", "ZhongliBus": "ä¸­å£¢å®¢é‹", "HsinchuBus": "æ–°ç«¹å®¢é‹", "YatungBus": "äºé€šå®¢é‹",
    "UnitedBus": "çµ±è¯å®¢é‹", "ChampionTransportation": "é‡‘å°å®¢é‹", "UnitedBus1": "ä¸­å°ç£å®¢é‹",
    "YosemiteBus": "ç§‘æŠ€ä¹‹æ˜Ÿ", "MiaoLi": "è‹—æ —å®¢é‹", "Jet-ChenBus": "æ·ä¹˜å®¢é‹", "Yi-JetTechIntegration": "äº¦æ·ç§‘éš›",
    "FengyuanBus": "è±åŸå®¢é‹", "TaichungBus": "è‡ºä¸­å®¢é‹", "GeyaBus": "å·¨æ¥­äº¤é€š", "ChuanHang": "å…¨èˆªå®¢é‹",
    "MiaoLiBus": "è‹—æ —å®¢é‹", "HO-HSINBus": "å’Œæ¬£å®¢é‹", "Chung-LuBus": "ä¸­é¹¿å®¢é‹", "AllDayBus": "ç¸½é”å®¢é‹",
    "freego": "å»ºæ˜å®¢é‹", "RuiyiTransportation": "ç¿å¥•äº¤é€š", "NANTOUBUS": "å—æŠ•å®¢é‹", "ChanghuaBus": "å½°åŒ–å®¢é‹",
    "YuanLinBus": "å“¡æ—å®¢é‹", "taisibus": "å°è¥¿å®¢é‹", "goto307": "æ‰æ—æºªå®¢é‹",
    "GreenTransit": "è±æ¦®å®¢é‹", "YunlinBus": "é›²æ—å®¢é‹", "SOLARbus": "æ—¥çµ±å®¢é‹", "ChiayiBus": "å˜‰ç¾©å®¢é‹",
    "ChiayiCountyBus": "å˜‰ç¾©ç¸£å…¬è»Šè™•", "AlishanBus": "é˜¿é‡Œå±±å®¢é‹", "SinhuaBus": "èˆˆå—å®¢é‹", "SingingBus": "æ–°ç‡Ÿå®¢é‹",
    "TainanBus": "åºœåŸå®¢é‹", "Han-ChengBus": "æ¼¢ç¨‹å®¢é‹", "KaohsiungBus": "é«˜é›„å®¢é‹", "E-DaBus": "ç¾©å¤§å®¢é‹",
    "SouthTaiwanBus": "å—è‡ºç£å®¢é‹", "GreatCityLifeBus": "æ¸¯éƒ½å®¢é‹", "PingTungBus": "å±æ±å®¢é‹", "KamalanBus": "è‘›ç‘ªè˜­å®¢é‹",
    "TarokoBus": "å¤ªé­¯é–£å®¢é‹", "hopelandbus": "è¯è¯å®¢é‹", "DiingDongBus": "é¼æ±å®¢é‹", "ShingDongBus": "èˆˆæ±å®¢é‹",
    "PuyumaTransportation": "æ™®æ‚ ç‘ªå®¢é‹", "EasternTopTransportation": "æ±å°ç£å®¢é‹", "TailianBus": "å°è¯å®¢é‹",
    "Kinmen": "é‡‘é–€ç¸£å…¬å…±è»Šèˆ¹ç®¡ç†è™•", "matsuebus": "é€£æ±Ÿç¸£å…¬å…±è»Šèˆ¹ç®¡ç†è™•", "phpto": "æ¾æ¹–ç¸£å…¬è»Šè™•", 
    "Other": "å…¶ä»–æ¥­è€…"
};

const BUSTYPE_NAMES = {
    "dieselbus": "æŸ´æ²¹å·´å£«", "electricbus": "é›»å‹•å·´å£«", "articulatedbus": "é›™ç¯€å·´å£«",
    "minibus": "å°å‹å·´å£«", "Freewaybusservice": "åœ‹é“å®¢é‹", "Other": "å…¶ä»–"
};

const operatorToManufacturer = {
    "TaichungBus": ["éœ§å³°ç«™", "è±åŸç«™", "æ±æµ·ç«™", "é«˜éµç«™", "æ¸…æ°´ç«™", "æ²™é¹¿ç«™", "å¤§ç”²ç«™", "åœ‹é“ç«™", "æ¢§æ£²ç«™"],
    "UnitedBus": ["è±å‹¢ç«™", "æ¸…æ°´ç«™", "çƒæ—¥ç«™", "æ–°ç¦ç«™", "éœ§å³°ç«™", "ä¸­ç§‘ç«™", "å¹²åŸç«™", "å…‰å¾©ç«™", "å¤§åœ’ç«™", "æ±å‹‡ç«™", "å…«å¾·ç«™", "å¹³é®ç«™", "é‡‘é¦¬ç«™", "è¥¿æ¸¯ç«™", "ç«¹å±±ç«™", "æ–—å…­ç«™", "åŒ—æ¸¯ç«™", "å˜‰ç¾©ç«™", "æ°¸åº·ç«™", "é¼“å±±ç«™", "ç¾…æ±ç«™", "èŠ±è“®ç«™", "ç‘è±ç«™"],
    "GeyaBus": ["å¤§ç”²ç«™", "æ²™é¹¿ç«™", "å¶ºæ±ç«™", "è¯é‚¦åœè»Šå ´"],
    "ChuanHang": ["æ—±æºªç«™", "è¯é‚¦åœè»Šå ´"],
    "FengyuanBus": ["å°ä¸­ç«™", "è±åŸç«™", "æ±å‹¢ç«™", "å¤§ç”²ç«™", "è°·é—œç«™", "å“è˜­ç«™", "æ¢§æ£²ç«™"],
    "southeastBus": ["è‹‘è£¡ç«™", "å¤§é‡Œç«™", "å…§æ¹–ç«™", "è¬èŠ³ç«™", "é«˜é›„ç«™"],
    "MiaoLiBus": ["å—è‹—ç«™", "é ­ä»½ç«™", "å—åº„ç«™", "è‹‘è£¡ç«™", "æ–°ç«¹ç«™", "è‹—æ —ç«™"],
    "UnitedBus1": ["è±å‹¢ç«™", "æ¸…æ°´ç«™", "çƒæ—¥ç«™", "æ–°ç¦ç«™", "éœ§å³°ç«™", "ä¸­ç§‘ç«™", "å¹²åŸç«™"],
    "HO-HSINBus": ["å°åŒ—ç«™", "å°ä¸­ç«™", "å°å—ç«™", "é«˜é›„ç«™"],
    "Chung-LuBus": ["å¤§ç”²ç«™", "åŒ—å±¯ç«™", "å¶ºæ±ç«™", "è¯é‚¦åœè»Šå ´"],
    "AllDayBus": ["å°ä¸­ç«™", "æ°´é‡Œç«™", "å—æŠ•ç«™"],
    "KuoKuang": ["å¹²åŸç«™", "äº”è‚¡ç«™", "æš–æš–ç«™", "é‡‘å±±ç«™", "ç¾…æ±ç«™", "å®œè˜­ç«™", "æ¡ƒåœ’ç«™", "ä¸­å£¢ç«™", "æ–°ç«¹ç«™", "ç«¹æ±ç«™", "è‹—æ —ç«™", "å½°åŒ–ç«™", "å—æŠ•ç«™", "åŸ”é‡Œç«™", "å˜‰ç¾©ç«™", "å°å—ç«™"],
    "freego": ["è‹‘è£¡ç«™(æ±å—å®¢é‹)"],
    "RuiyiTransportation": ["æ¢§æ£²ç«™", "å¤§ç”²ç«™", "æ±æµ·å¤§å­¸"],
    "NANTOUBUS": ["åŸ”é‡Œç«™"],
    "ChanghuaBus": ["å½°åŒ–ç«™", "å“¡æ—ç«™", "æ°´å°¾ç«™", "é¹¿æ¸¯ç«™", "å—æŠ•ç«™", "è‰å±¯ç«™", "ç”°ä¸­ç«™"],
    "YuanLinBus": ["æºªæ¹–ç«™", "äºŒæ—ç«™", "å“¡æ—ç«™", "å½°åŒ–ç«™", "ç”°ä¸­ç«™", "å°ä¸­ç«™", "ç«¹å±±ç«™", "æ°´é‡Œç«™", "é¹¿è°·ç«™"],
    "CapitalBus": ["ä¸‰é‡ä¸€ç«™", "ä¸‰é‡äºŒç«™", "äºŒé‡ç«™", "æ–°èŠä¸€ç«™", "æ–°èŠäºŒç«™", "æ–°èŠç«™(å¤§éƒ½æœƒå®¢é‹)", "ä¸‰å³½ä¸€ç«™(å°åŒ—å®¢é‹)", "å…§æ¹–ç«™", "æ±åœ’ç«™", "å£«æ—ç«™", "å—æ¸¯ç«™", "ç¶“è²¿æ–°ç«™(å……é›»ç«™)", "ç¶“è²¿ç«™", "æ±æ­¢ä¸€ç«™", "æ±æ­¢äºŒç«™", "ç¤¾å­ç«™", "å®‰åº·ç«™", "ç¾…æ±ç«™", "æ°‘ç”Ÿç«™(å°åŒ—å®¢é‹)", "æ¿æ©‹å‰ç«™(å°åŒ—å®¢é‹)", "æ¿æ©‹ç«™", "å…«æ–—å­ç«™", "åŸºéš†ç«™", "èŠ±è“®ç«™", "äº”çµç«™"],
    "KamalanBus": ["å¤§åœ’ç«™", "ç¾…æ±ç«™"],
    "YatungBus": ["æ–°åº—ç«™", "æ–°ç«¹ç«™"],
    "KeelungBus": ["åŸºéš†ç«™", "é‡‘å±±ç«™", "ç‘èŠ³ç«™", "åœŸåŸç«™"],
    "NewTaipeiBus": ["äº”å µç«™", "åŒ—å£«ç§‘ç«™(å…‰è¯å·´å£«)"],
    "SanChung": ["è˜†æ´²ä¸€ç«™", "è˜†æ´²äºŒç«™", "æ–°èŠç«™", "ä¸­æ¸¯ç«™", "åœŸåŸç«™", "å…«é‡Œç«™", "äº”è‚¡ç«™", "äº”è‚¡äºŒç«™", "æ¨¹æ—ç«™", "è¿´é¾ç«™", "æ·¡æµ·ç«™", "å…¬è¥¿ç«™", "æ—å£ç«™", "å—æ¸¯ç«™"],
    "SindianBus": ["æ–°åº—ç«™", "éŒ¦ç¹¡ç«™"],
    "TaoyuanBus": ["ä¸­å£¢å…¬è»Šç«™", "è§€éŸ³ç«™", "å¤§æºªç«™", "ä¸­å£¢ç«™", "ç«¹åœç«™", "é¾æ½­ç«™", "å¤§åœ’ç«™", "ä¸‰å³½ç«™", "æ¡ƒåœ’å…¬è»Šç«™", "ä¸­å£¢ç«™"],
    "HsinchuBus": ["æ–°ç«¹ç«™"],
    "SinhuaBus": ["å®‰å¹³å·¥æ¥­å€", "è‡ºå—ç«è»Šç«™", "ä½³é‡Œç«™", "æ–°åŒ–ç«™", "éº»è±†ç«™", "ç‰äº•ç«™", "æ¥ è¥¿ç«™"],
    "CitiAirBus": ["èˆŠèŠç«™", "æ–°èŠç«™", "ä¸­è¯ç«™"],
    "howtai": ["äº”è‚¡ç«™", "é¦™å±±ç«™"],
    "TaipeiBus": ["å—é›…ç«™", "æ­¡ä»”åœ’ç«™", "æ¿æ©‹å¾Œç«™", "äº”ç¦ç«™", "å››æµ·ç«™", "ä¸­å’Œç«™", "æ¨¹æ—ç«™", "æ–°åº—ç«™", "ä¸‰å³½ä¸€ç«™", "ä¸‰å³½äºŒç«™", "æœ¨æŸµç«™", "ä¸­è¯ç«™", "æ—å£ç«™", "è˜†æ´²ç«™", "æ°‘ç”Ÿç«™", "æ¿æ©‹å‰ç«™", "æ±Ÿå­ç¿ ç«™", "å£«æ—ç«™(é¦–éƒ½å®¢é‹)", "è±¡é ­åŸ”åœè»Šå ´", "ç‘èŠ³ç«™", "è˜‡æ¾³ç«™(å¤§éƒ½æœƒå®¢é‹)", "èŠ±è“®ç«™"],
    "HsinBus": ["ä¸­å¤®ç«™", "ä¸­èˆˆç«™", "å¯Œå¾·ç«™", "æœ¨æŸµäºŒç«™(å……é›»ç«™)", "æœ¨æŸµç«™(å……é›»ç«™)", "æ±æ¹–ç«™", "æ·±å‘ç«™", "è¯æ±Ÿç«™", "æ™¯æ–°ç«™", "æ™¯å¾·ç«™", "èˆˆéš†åœè»Šå ´"],
    "DaNan": ["ç§€å±±ç«™", "åœŸåŸç«™", "é—œæ¸¡ç«™", "å…§æ¹–ç«™", "ä¸­å¤®ç«™(æ¬£æ¬£å®¢é‹)", "æ™¯æ–°ç«™(æ¬£æ¬£å®¢é‹)", "ä¸‰é¶¯è½‰é‹ç«™"],
    "NewTaipeiBus": ["äº”å µç«™", "åŒ—å£«ç§‘ç«™(å…‰è¯å·´å£«)"],
    "ZhongxingBus": ["ä¸­å’Œç«™", "æ±æ­¢ç«™", "å¤©æ¯ç«™", "æ•…å®®ç«™", "æ³°å±±ç«™", "ä¸‰é‡ç«™", "ä¸‰èŠç«™(æ·¡æ°´å®¢é‹)", "åŒ—å£«ç§‘å……é›»ç«™(å…‰è¯å·´å£«)", "åŒ—å£«ç§‘ç«™(å…‰è¯å·´å£«)", "ä¸­å£¢ç«™"],
    "TamshuiBus": ["æ·¡æ°´ç«™", "ä¸‰èŠç«™", "å…«é‡Œç«™", "æ–°å¸‚ç«™"],
    "ZhinanBus": ["æ–°å…‰ç«™", "æ·±å‘ç«™", "å®‰å’Œç«™", "æ·¡æµ·ç«™", "æ¨¹æ—ç«™", "éŒ¦ç¹¡ç«™", "æ·¡å¤§ç«™", "äº”è‚¡ç«™", "æ³°å±±ç«™", "æ•…å®®ç«™(ä¸­èˆˆå·´å£«)", "éºŸå…‰ç«™", "ä¸‰é‡ç«™(ä¸­èˆˆå·´å£«)", "æ–°å¸‚ç«™(æ·¡æ°´å®¢é‹)", "å…«é‡Œç«™(æ·¡æ°´å®¢é‹)", "æ¡ƒåœ’ç«™", "åŒ—å£«ç§‘å……é›»ç«™(å…‰è¯å·´å£«)"],
    "MetropolitanTransport": ["å…§æ¹–ç«™", "è¬èŠ³ç«™", "é™½æ˜å±±ç«™", "æ±åœ’ç«™", "è˜†æ´²ç«™", "æ¾å¾·ç«™", "æ¦®ç¸½ç«™", "å³èˆˆè¡—ç«™", "ä¸­å’Œç«™", "å››æµ·ç«™(è‡ºåŒ—å®¢é‹)", "å‡Œé›²ç«™", "æ±æ¹–ç«™", "æ¾è·ç«™", "éºŸå…‰ç«™", "èˆŠèŠç«™", "å£«æ—ç«™", "å»ºåŒ—ç«™", "æ–°èŠç«™", "è˜‡æ¾³ç«™", "åŸºéš†ç«™", "æ—å£ç«™(å°åŒ—å®¢é‹)", "æ–°èŠäºŒç«™(é¦–éƒ½å®¢é‹)", "è±¡é ­åŸ”åœè»Šå ´(å°åŒ—å®¢é‹)", "æ–°åº—ç«™(å°åŒ—å®¢é‹)", "æ°‘ç”Ÿç«™"],
    "FuhobusInc": ["å¤§æ­¦å´™ç«™"],
    "Kuang-HuaBus": ["æ±æ¹–ç«™", "åŒ—å³°ç«™", "åŒ—å£«ç§‘ç«™", "å¤©æ±ç«™", "å¤©è¥¿ç«™", "æµ·å°ˆç«™", "æ•…å®®ç«™", "éºŸå…‰ç«™", "ä¸­å’Œç«™", "åŸºéš†ç«™(åŸºéš†å®¢é‹)"],
    "RoyalBus": ["åŠ æŠ•ç«™"],
    "TaoyuanBus": ["ä¸­å£¢å…¬è»Šç«™", "è§€éŸ³ç«™", "å¤§æºªç«™", "ä¸­å£¢ç«™", "ç«¹åœç«™", "é¾æ½­ç«™", "å¤§åœ’ç«™", "ä¸‰å³½ç«™", "æ¡ƒåœ’å…¬è»Šç«™", "ä¸­å£¢ç«™"],
    "ZhongliBus": ["ä¸­å£¢ç«™", "æ¡ƒåœ’ç«™"],
    "YatungBus": ["æ–°åº—ç«™", "æ–°ç«¹ç«™"],
    "KamalanBus": ["å¤§åœ’ç«™", "ç¾…æ±ç«™"],
    "YosemiteBus": ["æ–°ç«¹ç«™"],
    "taisibus": ["æ–—å…­ç«™", "è™å°¾è¥¿ç«™", "åŒ—æ¸¯ç«™", "è¥¿èºç«™", "æ–—å—ç«™", "ç«¹å±±ç«™"],
    "NANTOUBU": ["å°ä¸­å¹²åŸç«™", "é«˜éµå°ä¸­ç«™", "è‰å±¯æœå‹™è™•", "åŸ”é‡Œè½‰é‹ç«™", "æ—¥æœˆæ½­ç«™"],
    "GreenTransit": ["ä¸­èˆˆç«™"],
    "AlishanBus": ["å¤ªä¿ç«™"],
    "YunlinBus": ["é›²ç§‘å¤§ç«™"],
    "SOLARbus": ["æ–—å…­ç«™", "è¥¿èºç«™", "éº¥å¯®ç«™"],
    "ChiayiBus": ["ç¸½å…¬å¸", "ä¸­å±±ç¸½ç«™", "åŒ—æ¸¯ç«™", "æœ´å­ç«™"],
    "TainanBus": ["é ‚æ±ç«™", "èŒ„è£ç«™", "ä»å¾·è½‰é‹ç«™ï¼ˆèƒ¸è…”ç—…é™¢æ—)", "å¡­å—é‡Œ", "ä¸‹é¯¤é¯“ç«™"],
    "SinhuaBus": ["å®‰å¹³å·¥æ¥­å€", "è‡ºå—ç«è»Šç«™", "ä½³é‡Œç«™", "æ–°åŒ–ç«™", "éº»è±†ç«™", "ç‰äº•ç«™", "æ¥ è¥¿ç«™"],
    "SingingBus": ["ç¸½å…¬å¸", "æ–°ç‡Ÿç«™", "ç™½æ²³ç«™"],
    "Han-ChengBus": ["é‡‘ç…æ¹–ç«™", "æ–°ç‡Ÿç«™"],
    "GreatCityLifeBus": ["åŠ æ˜Œç«™", "å°æ¸¯ç«™", "å·¦ç‡Ÿå—ç«™", "å‰é®ç«™", "å»ºè»ç«™"],
    "KaohsiungBus": ["ç¸½å…¬å¸", "æ—åœ’ç«™", "å°ç‰çƒç«™", "é³³å±±ç«™", "å¤§é †ç«™", "å»ºåœ‹ç«™", "æ¥ æ¢“ç«™", "å²¡å±±ç«™", "èŒ„è£ç«™", "æ——å±±è½‰é‹ç«™", "æ——å±±åŒ—ç«™", "ç¾æ¿ƒç«™", "å…­é¾œç«™", "ç”²ä»™ç«™", "å°å—ç«™", "æ°´é–€è½‰é‹ç«™"],
    "SouthTaiwanBus": ["é«˜é›„ç«™"],
    "E-DaBus": ["ç¾©å¤§ç«™"],
    "PingTungBus": ["å±æ±ç«™", "å±ç§‘å¤§", "é‡Œæ¸¯ç«™", "é«˜æ¨¹ç«™", "ç¾æ¿ƒç«™", "æ°´é–€ç«™", "é¹½åŸ”ç«™", "æ½®å·ç«™", "æ±æ¸¯ç«™", "æ‹å¯®ç«™", "æ†æ˜¥ç«™", "å…±ç‡Ÿä¸­å¿ƒ"],
    "TarokoBus": ["æ±è¯å¤§å­¸ç«™",],
    "PuyumaTransportation": ["æ›´ç”Ÿè·¯è»Šå» "],
    "phpto": ["é¦¬å…¬ç¸½ç«™"],
    "matsuebus": ["åŒ—ç«¿", "å—ç«¿", "æ±è’", "è¥¿è’", "æ±å¼•"],
    "Kinmen": ["é‡‘åŸç«™(é‡‘åŸåœè»Šå ´)", "å±±å¤–ç«™(å»ºè¯åœè»Šå ´)", "æ²™ç¾ç«™", "çƒˆå¶¼ç«™"]
};

// --- 3. æ¬„ä½äº’å‹• ---
document.getElementById("operator").addEventListener("change", function() {
  const selected = this.value;
  const manuSelect = document.getElementById("manufacturer");
  manuSelect.innerHTML = "";
  
  if (operatorToManufacturer[selected]) {
    const def = document.createElement("option");
    def.value = ""; def.textContent = "--- è«‹é¸æ“‡è»Šå»  (éå¿…å¡«) ---"; def.selected = true;
    manuSelect.appendChild(def);
    operatorToManufacturer[selected].forEach(m => {
      const op = document.createElement("option");
      op.value = m; op.textContent = m;
      manuSelect.appendChild(op);
    });
  } else {
    const op = document.createElement("option");
    op.value = ""; op.textContent = "ç„¡å°æ‡‰è»Šå» è³‡æ–™ (éå¿…å¡«)";
    manuSelect.appendChild(op);
  }
});
document.getElementById("busNumber").addEventListener("input", function() { this.value = this.value.toUpperCase(); });

// --- 4. èªè­‰ ---
auth.onAuthStateChanged(user => {
  if (user) {
    document.getElementById("userEmail").textContent = user.email;
    document.getElementById("loginForm").style.display = "none";
    document.getElementById("userInfo").style.display = "block";
    loadRecords(user.uid);
  } else {
    document.getElementById("loginForm").style.display = "block";
    document.getElementById("userInfo").style.display = "none";
    document.getElementById("recordTable").querySelector("tbody").innerHTML = "";
    globalRecords = []; editDocId = null;
  }
});
async function signup() {
    const e = document.getElementById("email").value, p = document.getElementById("password").value;
    if(p.length<6) return alert("å¯†ç¢¼éœ€6ä½ä»¥ä¸Š");
    try { await auth.createUserWithEmailAndPassword(e,p); alert("è¨»å†ŠæˆåŠŸ"); } catch(e){ alert("éŒ¯èª¤:"+e.message); }
}
async function login() {
    const e = document.getElementById("email").value, p = document.getElementById("password").value;
    try { await auth.signInWithEmailAndPassword(e,p); alert("ç™»å…¥æˆåŠŸ"); } catch(e){ alert("éŒ¯èª¤:"+e.message); }
}
function logout() { auth.signOut(); alert("å·²ç™»å‡º"); document.getElementById("surveyForm").reset(); updateTimestamp(); }

// --- 5. è¼”åŠ© ---
function updateTimestamp() {
    const now = new Date();
    document.getElementById("timestamp").value = now.toLocaleString();
    const w = ["æ—¥","ä¸€","äºŒ","ä¸‰","å››","äº”","å…­"];
    document.getElementById("weekday").value = "æ˜ŸæœŸ" + w[now.getDay()];
}
function addRow(r, id) {
    const tbody = document.getElementById("recordTable").querySelector("tbody");
    const row = tbody.insertRow(-1);
    const d = [
        r.timestamp ? r.timestamp.toDate().toLocaleString() : 'N/A',
        r.weekday, OPERATOR_NAMES[r.operator]||r.operator, r.manufacturer,
        r.routeCode, r.busNumber, BUSTYPE_NAMES[r.busType]||r.busType, r.note
    ];
    d.forEach(v => row.insertCell().textContent = v);
    row.addEventListener("click", () => loadToForm(id));
}
function loadToForm(id) {
    db.collection("busRecords").doc(id).get().then(doc => {
        if(doc.exists) {
            const r = doc.data();
            document.getElementById("timestamp").value = r.timestamp.toDate().toLocaleString();
            document.getElementById("weekday").value = r.weekday;
            const op = document.getElementById("operator"); op.value = r.operator; op.dispatchEvent(new Event('change'));
            setTimeout(() => document.getElementById("manufacturer").value = r.manufacturer, 50);
            document.getElementById("routeCode").value = r.routeCode;
            document.getElementById("busNumber").value = r.busNumber;
            document.getElementById("busType").value = r.busType;
            document.getElementById("note").value = r.note;
            editDocId = id;
        }
    });
}

// --- 6. CRUD ---
async function saveData() {
    const user = auth.currentUser; if(!user) return alert("è«‹å…ˆç™»å…¥");
    const op = document.getElementById("operator").value, type = document.getElementById("busType").value, num = document.getElementById("busNumber").value;
    if(!op || !type || num.trim()==="") return alert("è«‹å¡«å¯«å®¢é‹ã€è»Šå‹èˆ‡è»Šè™Ÿ");
    
    try {
        await db.collection("busRecords").add({
            userId: user.uid, timestamp: firebase.firestore.FieldValue.serverTimestamp(),
            weekday: document.getElementById("weekday").value, operator: op,
            manufacturer: document.getElementById("manufacturer").value,
            routeCode: document.getElementById("routeCode").value,
            busNumber: num.toUpperCase(), busType: type,
            note: document.getElementById("note").value
        });
        alert("å„²å­˜æˆåŠŸ"); document.getElementById("surveyForm").reset(); updateTimestamp();
    } catch(e) { console.error(e); alert("å¤±æ•—"); }
}
async function saveEdit() {
    if(!editDocId) return alert("è«‹å…ˆé¸æ“‡ç´€éŒ„");
    const op = document.getElementById("operator").value, type = document.getElementById("busType").value, num = document.getElementById("busNumber").value;
    if(!op || !type || num.trim()==="") return alert("å¿…å¡«æ¬„ä½ç¼ºæ¼");
    try {
        await db.collection("busRecords").doc(editDocId).update({
            operator: op, manufacturer: document.getElementById("manufacturer").value,
            routeCode: document.getElementById("routeCode").value,
            busNumber: num.toUpperCase(), busType: type,
            note: document.getElementById("note").value
        });
        alert("ä¿®æ”¹æˆåŠŸ"); editDocId = null;
    } catch(e) { console.error(e); alert("å¤±æ•—"); }
}
async function deleteRecord() {
    if(!editDocId || !confirm("ç¢ºå®šåˆªé™¤?")) return;
    try { await db.collection("busRecords").doc(editDocId).delete(); alert("åˆªé™¤æˆåŠŸ"); document.getElementById("surveyForm").reset(); updateTimestamp(); editDocId=null; } catch(e){ alert("å¤±æ•—"); }
}
async function deleteAllRecords() {
    const user = auth.currentUser; if(!user) return;
    if(!confirm("ç¢ºå®šåˆªé™¤å…¨éƒ¨ç´€éŒ„?")) return;
    try {
        const q = await db.collection("busRecords").where("userId","==",user.uid).get();
        const b = db.batch(); q.forEach(d => b.delete(d.ref)); await b.commit();
        alert("å·²æ¸…ç©º"); document.getElementById("surveyForm").reset(); updateTimestamp();
    } catch(e){ console.error(e); alert("å¤±æ•—"); }
}

function loadRecords(uid) {
    db.collection("busRecords").where("userId","==",uid).orderBy("timestamp","desc").onSnapshot(s => {
        document.getElementById("recordTable").querySelector("tbody").innerHTML = "";
        globalRecords = [];
        s.docs.forEach(d => { globalRecords.push(d.data()); addRow(d.data(), d.id); });
    });
}

// --- 7. åŒ¯å‡º/åŒ¯å…¥/çµ±è¨ˆ ---
function exportCSV() {
    if(globalRecords.length===0) return alert("ç„¡è³‡æ–™");
    const data = globalRecords.map(r => ({
        "æ™‚é–“": r.timestamp?r.timestamp.toDate().toLocaleString():"", "æ˜ŸæœŸ": r.weekday,
        "å®¢é‹": OPERATOR_NAMES[r.operator]||r.operator, "è»Šå» ": r.manufacturer,
        "è·¯ç·š": r.routeCode, "è»Šè™Ÿ": r.busNumber, "è»Šå‹": BUSTYPE_NAMES[r.busType]||r.busType, "å‚™è¨»": r.note
    }));
    const wb = XLSX.utils.book_new(), ws = XLSX.utils.json_to_sheet(data);
    XLSX.utils.book_append_sheet(wb, ws, "Records");
    saveAs(new Blob([XLSX.write(wb,{bookType:'csv',type:'array'})],{type:'text/csv;charset=utf-8;'}), "bus_data.csv");
}

function showStats() {
    if(globalRecords.length===0) return alert("ç„¡è³‡æ–™");
    document.getElementById("statsModal").style.display = "block";
    document.getElementById("totalRides").textContent = globalRecords.length;
    document.getElementById("uniqueBuses").textContent = new Set(globalRecords.map(r=>r.busNumber)).size;
    const count = (k) => globalRecords.reduce((a,c)=>{ const v=c[k]||"(ç©º)"; a[v]=(a[v]||0)+1; return a; }, {});
    const opC = {}, rtC = {}, bnC = {};
    globalRecords.forEach(r => {
        opC[OPERATOR_NAMES[r.operator]||r.operator] = (opC[OPERATOR_NAMES[r.operator]||r.operator]||0)+1;
        rtC[r.routeCode||"(æœªå¡«)"] = (rtC[r.routeCode||"(æœªå¡«)"]||0)+1;
        bnC[r.busNumber] = (bnC[r.busNumber]||0)+1;
    });
    renderChart("topOperators", opC); renderChart("topRoutes", rtC); renderChart("topBusNumbers", bnC);
}
function renderChart(id, data) {
    const el = document.getElementById(id); el.innerHTML = "";
    Object.entries(data).sort((a,b)=>b[1]-a[1]).slice(0,5).forEach(([k,v],i,arr) => {
        el.innerHTML += `<div class="stat-row"><div class="stat-label">${k}</div><div class="stat-bar-container"><div class="stat-bar" style="width:${(v/arr[0][1])*100}%"></div><div class="stat-value">${v}</div></div></div>`;
    });
}
function closeStats() { document.getElementById("statsModal").style.display="none"; }
function showBusStats() {
    if(globalRecords.length===0) return alert("ç„¡è³‡æ–™");
    document.getElementById("busStatsModal").style.display = "block";
    const map = {};
    globalRecords.forEach(r => {
        const b = r.busNumber||"UNKNOWN";
        if(!map[b]) map[b] = {c:0, o: OPERATOR_NAMES[r.operator]||r.operator};
        map[b].c++;
    });
    const tbody = document.getElementById("busListBody"); tbody.innerHTML = "";
    Object.entries(map).sort((a,b)=>a[0].localeCompare(b[0])).forEach(([k,v]) => {
        tbody.innerHTML += `<tr><td><b>${k}</b></td><td>${v.c}</td><td>${v.o}</td></tr>`;
    });
}
function closeBusStats() { document.getElementById("busStatsModal").style.display="none"; }
window.onclick = e => { if(e.target.className==="modal") e.target.style.display="none"; }

// Excel Import
function handleFileSelect(input) {
    const f = input.files[0]; if(!f) return;
    const r = new FileReader();
    r.onload = e => {
        const wb = XLSX.read(new Uint8Array(e.target.result), {type:'array'});
        const data = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {raw:false});
        if(confirm(`åŒ¯å…¥ ${data.length} ç­†?`)) processImport(data);
        input.value = "";
    };
    r.readAsArrayBuffer(f);
}
async function processImport(data) {
    const user = auth.currentUser; if(!user) return;
    const revOp = Object.fromEntries(Object.entries(OPERATOR_NAMES).map(([k,v])=>[v,k]));
    const revType = Object.fromEntries(Object.entries(BUSTYPE_NAMES).map(([k,v])=>[v,k]));
    let c=0;
    for(const r of data) {
        let ts = new Date();
        if(r['æ™‚é–“æˆ³è¨˜']) {
             if(typeof r['æ™‚é–“æˆ³è¨˜']==='number') ts = new Date(Math.round((r['æ™‚é–“æˆ³è¨˜']-25569)*86400000));
             else ts = new Date(r['æ™‚é–“æˆ³è¨˜']);
        }
        await db.collection("busRecords").add({
            userId: user.uid, timestamp: firebase.firestore.Timestamp.fromDate(ts),
            weekday: "æ˜ŸæœŸ"+["æ—¥","ä¸€","äºŒ","ä¸‰","å››","äº”","å…­"][ts.getDay()],
            operator: revOp[r['å®¢é‹æ¥­è€…']]||"Other", manufacturer: r['è»Šå» ']||"",
            routeCode: String(r['è·¯ç·šç¢¼']||""), busNumber: String(r['è»Šè™Ÿ']||"UNKNOWN").toUpperCase(),
            busType: revType[r['è»Šå‹']]||"Other", note: r['å‚™è¨»']||"åŒ¯å…¥"
        });
        c++;
    }
    alert(`åŒ¯å…¥ ${c} ç­†æˆåŠŸ`);
}

updateTimestamp();
</script>
</body>
</html>
