<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>æ¯æ—¥æ­ä¹˜èª¿æŸ¥</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <style>
    body {
      font-family: "Microsoft JhengHei", Arial, sans-serif;
      background-color: #f9fafb;
      margin: 20px;
    }

    h1 {
      color: #2563eb;
      margin-bottom: 20px;
    }

    .form-group {
      margin-bottom: 15px;
    }

    label {
      font-weight: 600;
      color: #374151;
    }

    input, select, textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      transition: border-color 0.2s;
    }

    input:focus, select:focus, textarea:focus {
      border-color: #2563eb;
      outline: none;
    }

    button {
      background-color: #2563eb;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 10px 15px;
      margin-right: 10px;
      margin-bottom: 5px; /* é¿å…æ‰‹æ©Ÿç‰ˆæŒ‰éˆ•æ“ åœ¨ä¸€èµ· */
      cursor: pointer;
      transition: background-color 0.2s;
    }

    button:hover {
      background-color: #1e40af;
    }

    /* é‡å°ã€Œå…¨éƒ¨åˆªé™¤ã€æŒ‰éˆ•çš„ç‰¹æ®Šé¡è‰² */
    .delete-all-btn {
        background-color: #dc2626; /* ç´…è‰² */
    }
    .delete-all-btn:hover {
        background-color: #b91c1c;
    }

    /* é‡å°ã€Œçµ±è¨ˆã€æŒ‰éˆ•çš„ç‰¹æ®Šé¡è‰² (ç´«è‰²) */
    .stats-btn {
        background-color: #7c3aed; 
    }
    .stats-btn:hover {
        background-color: #6d28d9;
    }

    /* é‡å°ã€Œè»Šè™Ÿçµ±è¨ˆã€æŒ‰éˆ•çš„ç‰¹æ®Šé¡è‰² (ç¶ è‰²) */
    .bus-stats-btn {
        background-color: #059669; 
    }
    .bus-stats-btn:hover {
        background-color: #047857;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }

    table th, table td {
      padding: 10px;
      border: 1px solid #d1d5db;
      text-align: center;
    }

    table tbody tr:nth-child(even) {
      background-color: #f3f4f6;
    }

    /* --- çµ±è¨ˆæ¨¡æ…‹è¦–çª— (Modal) CSS --- */
    .modal {
        display: none; 
        position: fixed; 
        z-index: 1000; 
        left: 0;
        top: 0;
        width: 100%; 
        height: 100%; 
        overflow: auto; 
        background-color: rgba(0,0,0,0.5); 
    }

    .modal-content {
        background-color: #fefefe;
        margin: 5% auto; 
        padding: 20px;
        border: 1px solid #888;
        width: 90%; 
        max-width: 600px;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    
    /* è®“è»Šè™Ÿåˆ—è¡¨çš„è¦–çª—ç¨å¾®å¯¬ä¸€é»ï¼Œæ–¹ä¾¿é–±è®€è¡¨æ ¼ */
    .modal-content.wide-modal {
        max-width: 800px;
    }

    .close-btn {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
    }

    .close-btn:hover,
    .close-btn:focus {
        color: black;
        text-decoration: none;
        cursor: pointer;
    }

    .stat-section {
        margin-bottom: 25px;
    }
    .stat-section h3 {
        border-bottom: 2px solid #e5e7eb;
        padding-bottom: 5px;
        color: #374151;
    }
    
    /* çµ±è¨ˆé•·æ¢åœ–æ¨£å¼ */
    .stat-row {
        display: flex;
        align-items: center;
        margin-bottom: 8px;
        font-size: 14px;
    }
    .stat-label {
        width: 120px;
        text-align: right;
        padding-right: 10px;
        font-weight: bold;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .stat-bar-container {
        flex-grow: 1;
        background-color: #e5e7eb;
        height: 20px;
        border-radius: 10px;
        overflow: hidden;
        position: relative;
    }
    .stat-bar {
        background-color: #3b82f6;
        height: 100%;
        border-radius: 10px 0 0 10px;
    }
    .stat-value {
        position: absolute;
        right: 5px;
        top: 0;
        line-height: 20px;
        font-size: 12px;
        color: #374151;
    }
    .summary-cards {
        display: flex;
        justify-content: space-between;
        margin-bottom: 20px;
    }
    .summary-card {
        background: #eff6ff;
        padding: 15px;
        border-radius: 8px;
        text-align: center;
        width: 48%;
    }
    .summary-number {
        font-size: 24px;
        font-weight: bold;
        color: #2563eb;
    }
    
    /* è»Šè™Ÿåˆ—è¡¨å°ˆç”¨è¡¨æ ¼æ¨£å¼ */
    .bus-list-table th {
        background-color: #e5e7eb;
        color: #374151;
    }
  </style>
</head>
<body>
  <h1>æ¯æ—¥æ­ä¹˜èª¿æŸ¥</h1>
  <div id="authSection" style="margin-bottom: 30px; padding: 15px; border: 1px solid #d1d5db; border-radius: 8px;">
    <h2>ä½¿ç”¨è€…èªè­‰ (è·¨è£ç½®åŒæ­¥)</h2>
    <div id="loginForm">
      <input type="email" id="email" placeholder="Email" style="margin-bottom: 5px; padding: 10px; border-radius: 4px;">
      <input type="password" id="password" placeholder="å¯†ç¢¼" style="margin-bottom: 10px; padding: 10px; border-radius: 4px;">
      <button type="button" onclick="login()">ç™»å…¥</button>
      <button type="button" onclick="signup()">è¨»å†Š</button>
    </div>
    <div id="userInfo" style="display:none;">
      <p>ç›®å‰ç™»å…¥ï¼š<span id="userEmail" style="font-weight: bold;"></span></p>
      <button type="button" onclick="logout()">ç™»å‡º</button>
    </div>
  </div>
  <form id="surveyForm">
    <div class="form-group">
		  <label for="timestamp">æ™‚é–“æˆ³è¨˜</label>
		  <input type="text" id="timestamp" readonly> 
		</div>

		<div class="form-group">
		  <label for="weekday">æ˜ŸæœŸ</label>
		  <input type="text" id="weekday" readonly>
		</div>

    <div class="form-group">
      <label for="operator">å®¢é‹æ¥­è€…</label>
      <select id="operator" name="operator" required>
        <option value="" disabled selected>--- è«‹é¸æ“‡å®¢é‹æ¥­è€… ---</option>
         <optgroup label="åŸºéš†/æ–°åŒ—/è‡ºåŒ—">
              <option value="KeelungCity">åŸºéš†å¸‚å…¬è»Šè™•</option>
              <option value="KeelungBus">åŸºéš†å®¢é‹</option>
              <option value="CapitalBus">é¦–éƒ½å®¢é‹</option>
              <option value="TaipeiBus">è‡ºåŒ—å®¢é‹</option>
              <option value="ZhinanBus">æŒ‡å—å®¢é‹</option>
              <option value="NewTaipeiBus">æ–°åŒ—å®¢é‹</option>
              <option value="SanChung">ä¸‰é‡å®¢é‹</option>
              <option value="KuoKuang">åœ‹å…‰å®¢é‹</option>
              <option value="MetropolitanTransport">å¤§éƒ½æœƒå®¢é‹</option>
              <option value="ZhongxingBus">ä¸­èˆˆå·´å£«</option>
              <option value="Kuang-HuaBus">å…‰è¯å·´å£«</option>
              <option value="DaNan">å¤§å—æ±½è»Š</option>
              <option value="HsinBus">æ¬£æ¬£å®¢é‹</option>
              <option value="SindianBus">æ–°åº—å®¢é‹</option>
              <option value="TamshuiBus">æ·¡æ°´å®¢é‹</option>
              <option value="TaoyuanBus">æ¡ƒåœ’å®¢é‹</option>
              <option value="FuhobusInc">ç¦å’Œå®¢é‹</option>
              <option value="RoyalBus">çš‡å®¶å®¢é‹</option>
              <option value="howtai">è±ªæ³°å®¢é‹</option>
              <option value="southeastBus">æ±å—å®¢é‹</option>
              <option value="CitiAirBus">å¤§æœ‰å·´å£«</option>
            </optgroup>
            <optgroup label="æ¡ƒåœ’">
              <option value="TaoyuanBus">æ¡ƒåœ’å®¢é‹</option>
              <option value="ZhongliBus">ä¸­å£¢å®¢é‹</option>
              <option value="HsinchuBus">æ–°ç«¹å®¢é‹</option>
              <option value="YatungBus">äºé€šå®¢é‹</option>
              <option value="UnitedBus">çµ±è¯å®¢é‹</option>
              <option value="SanChung">ä¸‰é‡å®¢é‹</option>
              <option value="ZhinanBus">æŒ‡å—å®¢é‹</option>
              <option value="ChampionTransportation">é‡‘å°å®¢é‹</option>
            </optgroup>
             <optgroup label="æ–°ç«¹/è‹—æ —">
              <option value="HsinchuBus">æ–°ç«¹å®¢é‹</option>
              <option value="KuoKuang">åœ‹å…‰å®¢é‹</option>
              <option value="ChampionTransportation">é‡‘ç‰Œå®¢é‹</option>
              <option value="YosemiteBus">ç§‘æŠ€ä¹‹æ˜Ÿ</option>
              <option value="MiaoLi">è‹—æ —å®¢é‹</option>
              <option value="Jet-ChenBus">æ·ä¹˜å®¢é‹</option>
              <option value="Yi-JetTechIntegration">äº¦æ·ç§‘éš›</option>
              <option value="FengyuanBus">è±åŸå®¢é‹</option>
            </optgroup>
            <optgroup label="è‡ºä¸­å¸‚å„æ¥­è€…">
              <option value="TaichungBus">è‡ºä¸­å®¢é‹</option>
              <option value="UnitedBus">çµ±è¯å®¢é‹</option>
              <option value="GeyaBus">å·¨æ¥­äº¤é€š</option>
              <option value="ChuanHang">å…¨èˆªå®¢é‹</option>
              <option value="FengyuanBus">è±åŸå®¢é‹</option>
              <option value="southeastBus">æ±å—å®¢é‹</option>
              <option value="MiaoLiBus">è‹—æ —å®¢é‹</option>
              <option value="UnitedBus1">ä¸­å°ç£å®¢é‹</option>
              <option value="HO-HSINBus">å’Œæ¬£å®¢é‹</option>
              <option value="Chung-LuBus">ä¸­é¹¿å®¢é‹</option>
              <option value="AllDayBus">ç¸½é”å®¢é‹</option>
              <option value="KuoKuang">åœ‹å…‰å®¢é‹</option>
              <option value="freego">å»ºæ˜å®¢é‹</option>
              <option value="RuiyiTransportation">ç¿å¥•äº¤é€š</option>
            </optgroup>
            <optgroup label="å½°åŒ–">
              <option value="ChanghuaBus">å½°åŒ–å®¢é‹</option>
              <option value="YuanLinBus">å“¡æ—å®¢é‹</option>
              <option value="Chung-LuBus">ä¸­é¹¿å®¢é‹</option>
              <option value="TaichungBus">è‡ºä¸­å®¢é‹</option>
              <option value="GeyaBus">å·¨æ¥­äº¤é€š</option>
              <option value="taisibus">å°è¥¿å®¢é‹</option>
              <option value="UnitedBus">çµ±è¯å®¢é‹</option>
              <option value="KuoKuang">åœ‹å…‰å®¢é‹</option>
              <option value="NANTOUBUS">å—æŠ•å®¢é‹</option>
              <option value="FengyuanBus">è±åŸå®¢é‹</option>
              <option value="southeastBus">æ±å—å®¢é‹</option>
              <option value="freego">å»ºæ˜å®¢é‹</option>
            </optgroup>
            <optgroup label="å—æŠ•">
              <option value="NANTOUBUS">å—æŠ•å®¢é‹</option>
              <option value="ChanghuaBus">å½°åŒ–å®¢é‹</option>
              <option value="YuanLinBus">å“¡æ—å®¢é‹</option>
              <option value="AllDayBus">ç¸½é”å®¢é‹</option>
              <option value="TaichungBus">è‡ºä¸­å®¢é‹</option>
              <option value="goto307">æ‰æ—æºªå®¢é‹</option>
              <option value="GreenTransit">è±æ¦®å®¢é‹</option>
              <option value="ChuanHang">å…¨èˆªå®¢é‹</option>
              <option value="UnitedBus">çµ±è¯å®¢é‹</option>
            </optgroup>
            <optgroup label="é›²æ—">
              <option value="taisibus">å°è¥¿å®¢é‹</option>
              <option value="YunlinBus">é›²æ—å®¢é‹</option>
              <option value="SOLARbus">æ—¥çµ±å®¢é‹</option>
              <option value="ChiayiBus">å˜‰ç¾©å®¢é‹</option>
            </optgroup>
            <optgroup label="å˜‰ç¾©">
              <option value="ChiayiCountyBus">å˜‰ç¾©ç¸£å…¬è»Šè™•</option>
              <option value="ChiayiBus">å˜‰ç¾©å®¢é‹</option>
              <option value="taisibus">å°è¥¿å®¢é‹</option>
              <option value="YunlinBus">é›²æ—å®¢é‹</option>
              <option value="AlishanBus">é˜¿é‡Œå±±å®¢é‹</option>
              <option value="KuoKuang">åœ‹å…‰å®¢é‹</option>
              <option value="Jet-ChenBus">æ·ä¹˜å®¢é‹</option>
            </optgroup>
            <optgroup label="è‡ºå—">
              <option value="SinhuaBus">èˆˆå—å®¢é‹</option>
              <option value="SingingBus">æ–°ç‡Ÿå®¢é‹</option>
              <option value="TainanBus">åºœåŸå®¢é‹</option>
              <option value="Han-ChengBus">æ¼¢ç¨‹å®¢é‹</option>
              <option value="GeyaBus">å·¨æ¥­äº¤é€š</option>
              <option value="UnitedBus">çµ±è¯å®¢é‹</option>
              <option value="KaohsiungBus">é«˜é›„å®¢é‹</option>
              <option value="E-DaBus">ç¾©å¤§å®¢é‹</option>
            </optgroup>
            <optgroup label="é«˜é›„">
              <option value="KaohsiungBus">é«˜é›„å®¢é‹</option>
              <option value="SouthTaiwanBus">å—è‡ºç£å®¢é‹</option>
              <option value="Han-ChengBus">æ¼¢ç¨‹å®¢é‹</option>
              <option value="GreatCityLifeBus">æ¸¯éƒ½å®¢é‹</option>
              <option value="E-DaBus">ç¾©å¤§å®¢é‹</option>
              <option value="UnitedBus">çµ±è¯å®¢é‹</option>
              <option value="southeastBus">æ±å—å®¢é‹</option>
            </optgroup>
            <optgroup label="å±æ±">
              <option value="PingTungBus">å±æ±å®¢é‹</option>
              <option value="KaohsiungBus">é«˜é›„å®¢é‹</option>
              <option value="Jet-ChenBus">æ·ä¹˜å®¢é‹</option>
            </optgroup>
            <optgroup label="å®œè˜­">
              <option value="MetropolitanTransport">å¤§éƒ½æœƒå®¢é‹</option>
              <option value="CapitalBus">é¦–éƒ½å®¢é‹</option>
              <option value="KamalanBus">è‘›ç‘ªè˜­å®¢é‹</option>
              <option value="KuoKuang">åœ‹å…‰å®¢é‹</option>
            </optgroup>
            <optgroup label="èŠ±è“®">
              <option value="TarokoBus">å¤ªé­¯é–£å®¢é‹</option>
              <option value="hopelandbus">è¯è¯å®¢é‹</option>
              <option value="UnitedBus">çµ±è¯å®¢é‹</option>
              <option value="DiingDongBus">é¼æ±å®¢é‹</option>
              <option value="ShingDongBus">èˆˆæ±å®¢é‹</option>
            </optgroup>
            <optgroup label="å°æ±">
              <option value="PuyumaTransportation">æ™®æ‚ ç‘ªå®¢é‹</option>
              <option value="DiingDongBus">é¼æ±å®¢é‹</option>
              <option value="EasternTopTransportation">æ±å°ç£å®¢é‹</option>
              <option value="ShingDongBus">èˆˆæ±å®¢é‹</option>
            </optgroup>
             <optgroup label="é›¢å³¶">
              <option value="phpto">æ¾æ¹–ç¸£å…¬è»Šè™•</option>
              <option value="matsuebus">é€£æ±Ÿç¸£å…¬å…±è»Šèˆ¹ç®¡ç†è™•</option>
              <option value="Kinmen">é‡‘é–€ç¸£å…¬å…±è»Šèˆ¹ç®¡ç†è™•</option>
            </optgroup>
            <optgroup label="åœ‹é“/é•·é€”å®¢é‹">
              <option value="KuoKuang">åœ‹å…‰å®¢é‹</option>
              <option value="UnitedBus">çµ±è¯å®¢é‹</option>
              <option value="CapitalBus">é¦–éƒ½å®¢é‹</option>
              <option value="HO-HSINBus">å’Œæ¬£å®¢é‹</option>
              <option value="KamalanBus">è‘›ç‘ªè˜­å®¢é‹</option>
              <option value="YatungBus">äºé€šå®¢é‹</option>
              <option value="TailianBus">å°è¯å®¢é‹</option>
              <option value="KeelungBus">åŸºéš†å®¢é‹</option>
              <option value="NewTaipeiBus">æ–°åŒ—å®¢é‹</option>
              <option value="SanChung">ä¸‰é‡å®¢é‹</option>
              <option value="SindianBus">æ–°åº—å®¢é‹</option>
              <option value="TaoyuanBus">æ¡ƒåœ’å®¢é‹</option>
              <option value="HsinchuBus">æ–°ç«¹å®¢é‹</option>
              <option value="TaichungBus">è‡ºä¸­å®¢é‹</option>
              <option value="AllDayBus">ç¸½é”å®¢é‹</option>
              <option value="SinhuaBus">èˆˆå—å®¢é‹</option>
              <option value="CitiAirBus">å¤§æœ‰å·´å£«</option>
              <option value="howtai">è±ªæ³°å®¢é‹</option>
            </optgroup>
	    <optgroup label="å…¶ä»–">
            <option value="Other">å…¶ä»–æ¥­è€… (è«‹åœ¨å‚™è¨»æ¬„è¨»æ˜)</option>
          </select>
    </div>
	<div class="form-group">
  <label for="manufacturer">è»Šå» </label>
  <select id="manufacturer" name="manufacturer" required>
    <option value="" disabled selected>--- è«‹å…ˆé¸æ“‡å®¢é‹æ¥­è€… ---</option>
 </select>
</div>

    <div class="form-group">
      <label>è·¯ç·šè™Ÿç¢¼</label>
      <input type="text" id="routeCode">
    </div>

    <div class="form-group">
      <label>è»Šè™Ÿ</label>
      <input type="text" id="busNumber" required>
    </div>

    <label>è»Šå‹</label>
  <select id="busType" name="busType" required>
  <option value="" disabled selected>--- è«‹é¸æ“‡è»Šå‹ ---</option>
  <option value="dieselbus">æŸ´æ²¹å·´å£«</option>
  <option value="electricbus">é›»å‹•å·´å£«</option>
  <option value="articulatedbus">é›™ç¯€å·´å£«</option>
  <option value="minibus">å°å‹å·´å£«</option>
  <option value="Freewaybusservice">åœ‹é“å®¢é‹</option>
  <option value="Other">å…¶ä»–</option>
</select>

    <div class="form-group">
      <label>å‚™è¨»</label>
      <textarea id="note"></textarea>
    </div>

    <button type="button" onclick="saveData()">å„²å­˜ç´€éŒ„</button>
    <button type="button" onclick="saveEdit()">å„²å­˜ä¿®æ”¹</button>
    <button type="button" onclick="deleteRecord()">åˆªé™¤ç´€éŒ„</button>
    <button type="button" onclick="exportCSV()">åŒ¯å‡º CSV</button>
    <button type="button" onclick="showStats()" class="stats-btn">ğŸ“Š çµ±è¨ˆè³‡æ–™</button>
    <button type="button" onclick="showBusStats()" class="bus-stats-btn">ğŸšŒ è»Šè™Ÿçµ±è¨ˆåˆ—è¡¨</button>
    <button type="button" onclick="deleteAllRecords()" class="delete-all-btn">å…¨éƒ¨åˆªé™¤</button>
    
    <input type="file" id="importFile" accept=".xlsx, .xls, .csv" style="display:none" onchange="handleFileSelect(this)">
    <button type="button" onclick="document.getElementById('importFile').click()" style="background-color: #10b981;">åŒ¯å…¥ Excel</button>
  </form>

  <h2>ç´€éŒ„æ¸…å–®</h2>
  <table border="1" id="recordTable">
    <thead>
      <tr>
        <th>æ™‚é–“æˆ³è¨˜</th><th>æ˜ŸæœŸ</th><th>å®¢é‹æ¥­è€…</th>
        <th>è»Šå» </th><th>è·¯ç·šç¢¼</th><th>è»Šè™Ÿ</th>
        <th>è»Šå‹</th><th>å‚™è¨»</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div id="statsModal" class="modal">
    <div class="modal-content">
      <span class="close-btn" onclick="closeStats()">&times;</span>
      <h2 style="text-align: center; color: #2563eb;">ğŸšŒ æ­ä¹˜çµ±è¨ˆåˆ†æ</h2>
      
      <div class="summary-cards">
          <div class="summary-card">
              <div>ç¸½æ­ä¹˜æ¬¡æ•¸</div>
              <div class="summary-number" id="totalRides">0</div>
          </div>
           <div class="summary-card">
              <div>ä¸é‡è¤‡è»Šè™Ÿ</div>
              <div class="summary-number" id="uniqueBuses">0</div>
          </div>
      </div>

      <div class="stat-section">
          <h3>ğŸ† æœ€å¸¸æ­çš„å®¢é‹æ¥­è€… (Top 5)</h3>
          <div id="topOperators"></div>
      </div>

      <div class="stat-section">
          <h3>ğŸ›£ï¸ æœ€å¸¸æ­çš„è·¯ç·š (Top 5)</h3>
          <div id="topRoutes"></div>
      </div>

      <div class="stat-section">
          <h3>ğŸšŒ æœ€å¸¸æ­åˆ°çš„è»Šè™Ÿ (Top 5)</h3>
          <div id="topBusNumbers"></div>
      </div>
    </div>
  </div>

  <div id="busStatsModal" class="modal">
    <div class="modal-content wide-modal">
      <span class="close-btn" onclick="closeBusStats()">&times;</span>
      <h2 style="text-align: center; color: #059669;">ğŸšŒ è»Šè™Ÿçµ±è¨ˆåˆ—è¡¨</h2>
      <p style="text-align: center; margin-bottom: 20px; color: #666;">ä¾ç…§è»Šè™Ÿæ’åº (A-Z)</p>
      
      <div style="overflow-x: auto;">
          <table class="bus-list-table">
            <thead>
                <tr>
                    <th>è»Šè™Ÿ</th>
                    <th>æ¬¡æ•¸</th>
                    <th>æ‰€å±¬å®¢é‹æ¥­è€…</th>
                </tr>
            </thead>
            <tbody id="busListBody">
                </tbody>
          </table>
      </div>
    </div>
  </div>

<script>
// --- 1. Firebase åˆå§‹åŒ–è¨­å®š ---
const firebaseConfig = {
    // âš ï¸ è­¦å‘Šï¼šé€™äº›é‡‘é‘°æ˜¯å…¬é–‹çš„ï¼Œè«‹å‹™å¿…è¨­å®šåš´æ ¼çš„ Firestore å®‰å…¨è¦å‰‡ï¼Œç¢ºä¿åªæœ‰ç™»å…¥è€…èƒ½å­˜å–è‡ªå·±çš„è³‡æ–™ï¼
    apiKey: "AIzaSyAKTHlEzkOx8uZWOcfTr8YHZj6-bd74MeE",
    authDomain: "jun-bus.firebaseapp.com",
    projectId: "jun-bus",
    storageBucket: "jun-bus.firebasestorage.app",
    messagingSenderId: "685457601811",
    appId: "1:685457601811:web:02f59887b6895879ac96e6",
    measurementId: "G-HPTP7MMCDV"
};

// ä½¿ç”¨ CDN å¼•å…¥çš„èªæ³•é€²è¡Œåˆå§‹åŒ–
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

let editDocId = null; // ç´€éŒ„ç›®å‰æ­£åœ¨ç·¨è¼¯çš„ Firestore æ–‡ä»¶ ID
let globalRecords = []; // ç”¨ä¾†å„²å­˜æ‰€æœ‰ç´€éŒ„ä»¥ä¾¿çµ±è¨ˆ

// --- 2. åç¨±ç¿»è­¯è¡¨ ---

// å®¢é‹æ¥­è€…åç¨±å°æ‡‰è¡¨ (Code -> ä¸­æ–‡ Text)
const OPERATOR_NAMES = {
    "KeelungCity": "åŸºéš†å¸‚å…¬è»Šè™•", "KeelungBus": "åŸºéš†å®¢é‹", "CapitalBus": "é¦–éƒ½å®¢é‹", "TaipeiBus": "è‡ºåŒ—å®¢é‹",
    "ZhinanBus": "æŒ‡å—å®¢é‹", "NewTaipeiBus": "æ–°åŒ—å®¢é‹", "SanChung": "ä¸‰é‡å®¢é‹", "KuoKuang": "åœ‹å…‰å®¢é‹",
    "MetropolitanTransport": "å¤§éƒ½æœƒå®¢é‹", "ZhongxingBus": "ä¸­èˆˆå·´å£«", "Kuang-HuaBus": "å…‰è¯å·´å£«", "DaNan": "å¤§å—æ±½è»Š",
    "HsinBus": "æ¬£æ¬£å®¢é‹", "SindianBus": "æ–°åº—å®¢é‹", "TamshuiBus": "æ·¡æ°´å®¢é‹", "TaoyuanBus": "æ¡ƒåœ’å®¢é‹",
    "FuhobusInc": "ç¦å’Œå®¢é‹", "RoyalBus": "çš‡å®¶å®¢é‹", "howtai": "è±ªæ³°å®¢é‹", "southeastBus": "æ±å—å®¢é‹",
    "CitiAirBus": "å¤§æœ‰å·´å£«", "ZhongliBus": "ä¸­å£¢å®¢é‹", "HsinchuBus": "æ–°ç«¹å®¢é‹", "YatungBus": "äºé€šå®¢é‹",
    "UnitedBus": "çµ±è¯å®¢é‹", "ChampionTransportation": "é‡‘å°å®¢é‹", "UnitedBus1": "ä¸­å°ç£å®¢é‹",
    "YosemiteBus": "ç§‘æŠ€ä¹‹æ˜Ÿ", "MiaoLi": "è‹—æ —å®¢é‹", "Jet-ChenBus": "æ·ä¹˜å®¢é‹", "Yi-JetTechIntegration": "äº¦æ·ç§‘éš›",
    "FengyuanBus": "è±åŸå®¢é‹", "TaichungBus": "è‡ºä¸­å®¢é‹", "GeyaBus": "å·¨æ¥­äº¤é€š", "ChuanHang": "å…¨èˆªå®¢é‹",
    "MiaoLiBus": "è‹—æ —å®¢é‹", "HO-HSINBus": "å’Œæ¬£å®¢é‹", "Chung-LuBus": "ä¸­é¹¿å®¢é‹", "AllDayBus": "ç¸½é”å®¢é‹",
    "freego": "å»ºæ˜å®¢é‹", "RuiyiTransportation": "ç¿å¥•äº¤é€š", "NANTOUBUS": "å—æŠ•å®¢é‹", "ChanghuaBus": "å½°åŒ–å®¢é‹",
    "YuanLinBus": "å“¡æ—å®¢é‹", "taisibus": "å°è¥¿å®¢é‹", "goto307": "æ‰æ—æºªå®¢é‹",
    "GreenTransit": "è±æ¦®å®¢é‹", "YunlinBus": "é›²æ—å®¢é‹", "SOLARbus": "æ—¥çµ±å®¢é‹", "ChiayiBus": "å˜‰ç¾©å®¢é‹",
    "ChiayiCountyBus": "å˜‰ç¾©ç¸£å…¬è»Šè™•", "AlishanBus": "é˜¿é‡Œå±±å®¢é‹", "SinhuaBus": "èˆˆå—å®¢é‹", "SingingBus": "æ–°ç‡Ÿå®¢é‹",
    "TainanBus": "åºœåŸå®¢é‹", "Han-ChengBus": "æ¼¢ç¨‹å®¢é‹", "KaohsiungBus": "é«˜é›„å®¢é‹", "E-DaBus": "ç¾©å¤§å®¢é‹",
    "SouthTaiwanBus": "å—è‡ºç£å®¢é‹", "GreatCityLifeBus": "æ¸¯éƒ½å®¢é‹", "PingTungBus": "å±æ±å®¢é‹", "KamalanBus": "è‘›ç‘ªè˜­å®¢é‹",
    "TarokoBus": "å¤ªé­¯é–£å®¢é‹", "hopelandbus": "è¯è¯å®¢é‹", "DiingDongBus": "é¼æ±å®¢é‹", "ShingDongBus": "èˆˆæ±å®¢é‹",
    "PuyumaTransportation": "æ™®æ‚ ç‘ªå®¢é‹", "EasternTopTransportation": "æ±å°ç£å®¢é‹", "TailianBus": "å°è¯å®¢é‹",
    "Kinmen": "é‡‘é–€ç¸£å…¬å…±è»Šèˆ¹ç®¡ç†è™•", "matsuebus": "é€£æ±Ÿç¸£å…¬å…±è»Šèˆ¹ç®¡ç†è™•", "phpto": "æ¾æ¹–ç¸£å…¬è»Šè™•", 
    "Other": "å…¶ä»–æ¥­è€…"
};

// è»Šå‹åç¨±å°æ‡‰è¡¨ (Code -> ä¸­æ–‡ Text)
const BUSTYPE_NAMES = {
    "dieselbus": "æŸ´æ²¹å·´å£«",
    "electricbus": "é›»å‹•å·´å£«",
    "articulatedbus": "é›™ç¯€å·´å£«",
    "minibus": "å°å‹å·´å£«",
    "Freewaybusservice": "åœ‹é“å®¢é‹",
    "Other": "å…¶ä»–"
};

// --- 3. æ¬„ä½äº’å‹•é‚è¼¯ ---

// å®¢é‹æ¥­è€… â†’ è»Šå» å°æ‡‰è¡¨ 
const operatorToManufacturer = {
    "TaichungBus": ["éœ§å³°ç«™", "è±åŸç«™", "æ±æµ·ç«™", "é«˜éµç«™", "æ¸…æ°´ç«™", "æ²™é¹¿ç«™", "å¤§ç”²ç«™", "åœ‹é“ç«™", "æ¢§æ£²ç«™"],
    "UnitedBus": ["è±å‹¢ç«™", "æ¸…æ°´ç«™", "çƒæ—¥ç«™", "æ–°ç¦ç«™", "éœ§å³°ç«™", "ä¸­ç§‘ç«™", "å¹²åŸç«™", "å…‰å¾©ç«™", "å¤§åœ’ç«™", "æ±å‹‡ç«™", "å…«å¾·ç«™", "å¹³é®ç«™", "é‡‘é¦¬ç«™", "è¥¿æ¸¯ç«™", "ç«¹å±±ç«™", "æ–—å…­ç«™", "åŒ—æ¸¯ç«™", "å˜‰ç¾©ç«™", "æ°¸åº·ç«™", "é¼“å±±ç«™", "ç¾…æ±ç«™", "èŠ±è“®ç«™", "ç‘è±ç«™"],
    "GeyaBus": ["å¤§ç”²ç«™", "æ²™é¹¿ç«™", "å¶ºæ±ç«™", "è¯é‚¦åœè»Šå ´"],
    "ChuanHang": ["æ—±æºªç«™", "è¯é‚¦åœè»Šå ´"],
    "FengyuanBus": ["å°ä¸­ç«™", "è±åŸç«™", "æ±å‹¢ç«™", "å¤§ç”²ç«™", "è°·é—œç«™", "å“è˜­ç«™", "æ¢§æ£²ç«™"],
    "southeastBus": ["è‹‘è£¡ç«™", "å¤§é‡Œç«™", "å…§æ¹–ç«™", "è¬èŠ³ç«™", "é«˜é›„ç«™"],
    "MiaoLiBus": ["å—è‹—ç«™", "é ­ä»½ç«™", "å—åº„ç«™", "è‹‘è£¡ç«™", "æ–°ç«¹ç«™", "è‹—æ —ç«™"],
    "UnitedBus1": ["è±å‹¢ç«™", "æ¸…æ°´ç«™", "çƒæ—¥ç«™", "æ–°ç¦ç«™", "éœ§å³°ç«™", "ä¸­ç§‘ç«™", "å¹²åŸç«™"],
    "HO-HSINBus": ["å°åŒ—ç«™", "å°ä¸­ç«™", "å°å—ç«™", "é«˜é›„ç«™"],
    "Chung-LuBus": ["å¤§ç”²ç«™", "åŒ—å±¯ç«™", "å¶ºæ±ç«™", "è¯é‚¦åœè»Šå ´"],
    "AllDayBus": ["å°ä¸­ç«™", "æ°´é‡Œç«™", "å—æŠ•ç«™"],
    "KuoKuang": ["å¹²åŸç«™", "äº”è‚¡ç«™", "æš–æš–ç«™", "é‡‘å±±ç«™", "ç¾…æ±ç«™", "å®œè˜­ç«™", "æ¡ƒåœ’ç«™", "ä¸­å£¢ç«™", "æ–°ç«¹ç«™", "ç«¹æ±ç«™", "è‹—æ —ç«™", "å½°åŒ–ç«™", "å—æŠ•ç«™", "åŸ”é‡Œç«™", "å˜‰ç¾©ç«™", "å°å—ç«™"],
    "freego": ["è‹‘è£¡ç«™(æ±å—å®¢é‹)"],
    "RuiyiTransportation": ["æ¢§æ£²ç«™", "å¤§ç”²ç«™", "æ±æµ·å¤§å­¸"],
    "NANTOUBUS": ["åŸ”é‡Œç«™"],
    "ChanghuaBus": ["å½°åŒ–ç«™", "å“¡æ—ç«™", "æ°´å°¾ç«™", "é¹¿æ¸¯ç«™", "å—æŠ•ç«™", "è‰å±¯ç«™", "ç”°ä¸­ç«™"],
    "YuanLinBus": ["æºªæ¹–ç«™", "äºŒæ—ç«™", "å“¡æ—ç«™", "å½°åŒ–ç«™", "ç”°ä¸­ç«™", "å°ä¸­ç«™", "ç«¹å±±ç«™", "æ°´é‡Œç«™", "é¹¿è°·ç«™"],
    "CapitalBus": ["ä¸‰é‡ä¸€ç«™", "ä¸‰é‡äºŒç«™", "äºŒé‡ç«™", "æ–°èŠä¸€ç«™", "æ–°èŠäºŒç«™", "æ–°èŠç«™(å¤§éƒ½æœƒå®¢é‹)", "ä¸‰å³½ä¸€ç«™(å°åŒ—å®¢é‹)", "å…§æ¹–ç«™", "æ±åœ’ç«™", "å£«æ—ç«™", "å—æ¸¯ç«™", "ç¶“è²¿æ–°ç«™(å……é›»ç«™)", "ç¶“è²¿ç«™", "æ±æ­¢ä¸€ç«™", "æ±æ­¢äºŒç«™", "ç¤¾å­ç«™", "å®‰åº·ç«™", "ç¾…æ±ç«™", "æ°‘ç”Ÿç«™(å°åŒ—å®¢é‹)", "æ¿æ©‹å‰ç«™(å°åŒ—å®¢é‹)", "æ¿æ©‹ç«™", "å…«æ–—å­ç«™", "åŸºéš†ç«™", "èŠ±è“®ç«™", "äº”çµç«™"],
    "KamalanBus": ["å¤§åœ’ç«™", "ç¾…æ±ç«™"],
    "YatungBus": ["æ–°åº—ç«™", "æ–°ç«¹ç«™"],
    "KeelungBus": ["åŸºéš†ç«™", "é‡‘å±±ç«™", "ç‘èŠ³ç«™", "åœŸåŸç«™"],
    "NewTaipeiBus": ["äº”å µç«™", "åŒ—å£«ç§‘ç«™(å…‰è¯å·´å£«)"],
    "SanChung": ["è˜†æ´²ä¸€ç«™", "è˜†æ´²äºŒç«™", "æ–°èŠç«™", "ä¸­æ¸¯ç«™", "åœŸåŸç«™", "å…«é‡Œç«™", "äº”è‚¡ç«™", "äº”è‚¡äºŒç«™", "æ¨¹æ—ç«™", "è¿´é¾ç«™", "æ·¡æµ·ç«™", "å…¬è¥¿ç«™", "æ—å£ç«™", "å—æ¸¯ç«™"],
    "SindianBus": ["æ–°åº—ç«™", "éŒ¦ç¹¡ç«™"],
    "TaoyuanBus": ["ä¸­å£¢å…¬è»Šç«™", "è§€éŸ³ç«™", "å¤§æºªç«™", "ä¸­å£¢ç«™", "ç«¹åœç«™", "é¾æ½­ç«™", "å¤§åœ’ç«™", "ä¸‰å³½ç«™", "æ¡ƒåœ’å…¬è»Šç«™", "ä¸­å£¢ç«™"],
    "HsinchuBus": ["æ–°ç«¹ç«™"],
    "SinhuaBus": ["å®‰å¹³å·¥æ¥­å€", "è‡ºå—ç«è»Šç«™", "ä½³é‡Œç«™", "æ–°åŒ–ç«™", "éº»è±†ç«™", "ç‰äº•ç«™", "æ¥ è¥¿ç«™"],
    "CitiAirBus": ["èˆŠèŠç«™", "æ–°èŠç«™", "ä¸­è¯ç«™"],
    "howtai": ["äº”è‚¡ç«™", "é¦™å±±ç«™"],
    "TaipeiBus": ["å—é›…ç«™", "æ­¡ä»”åœ’ç«™", "æ¿æ©‹å¾Œç«™", "äº”ç¦ç«™", "å››æµ·ç«™", "ä¸­å’Œç«™", "æ¨¹æ—ç«™", "æ–°åº—ç«™", "ä¸‰å³½ä¸€ç«™", "ä¸‰å³½äºŒç«™", "æœ¨æŸµç«™", "ä¸­è¯ç«™", "æ—å£ç«™", "è˜†æ´²ç«™", "æ°‘ç”Ÿç«™", "æ¿æ©‹å‰ç«™", "æ±Ÿå­ç¿ ç«™", "å£«æ—ç«™(é¦–éƒ½å®¢é‹)", "è±¡é ­åŸ”åœè»Šå ´", "ç‘èŠ³ç«™", "è˜‡æ¾³ç«™(å¤§éƒ½æœƒå®¢é‹)", "èŠ±è“®ç«™"],
    "HsinBus": ["ä¸­å¤®ç«™", "ä¸­èˆˆç«™", "å¯Œå¾·ç«™", "æœ¨æŸµäºŒç«™(å……é›»ç«™)", "æœ¨æŸµç«™(å……é›»ç«™)", "æ±æ¹–ç«™", "æ·±å‘ç«™", "è¯æ±Ÿç«™", "æ™¯æ–°ç«™", "æ™¯å¾·ç«™", "èˆˆéš†åœè»Šå ´"],
    "DaNan": ["ç§€å±±ç«™", "åœŸåŸç«™", "é—œæ¸¡ç«™", "å…§æ¹–ç«™", "ä¸­å¤®ç«™(æ¬£æ¬£å®¢é‹)", "æ™¯æ–°ç«™(æ¬£æ¬£å®¢é‹)", "ä¸‰é¶¯è½‰é‹ç«™"],
    "NewTaipeiBus": ["äº”å µç«™", "åŒ—å£«ç§‘ç«™(å…‰è¯å·´å£«)"],
    "ZhongxingBus": ["ä¸­å’Œç«™", "æ±æ­¢ç«™", "å¤©æ¯ç«™", "æ•…å®®ç«™", "æ³°å±±ç«™", "ä¸‰é‡ç«™", "ä¸‰èŠç«™(æ·¡æ°´å®¢é‹)", "åŒ—å£«ç§‘å……é›»ç«™(å…‰è¯å·´å£«)", "åŒ—å£«ç§‘ç«™(å…‰è¯å·´å£«)", "ä¸­å£¢ç«™"],
    "TamshuiBus": ["æ·¡æ°´ç«™", "ä¸‰èŠç«™", "å…«é‡Œç«™", "æ–°å¸‚ç«™"],
    "ZhinanBus": ["æ–°å…‰ç«™", "æ·±å‘ç«™", "å®‰å’Œç«™", "æ·¡æµ·ç«™", "æ¨¹æ—ç«™", "éŒ¦ç¹¡ç«™", "æ·¡å¤§ç«™", "äº”è‚¡ç«™", "æ³°å±±ç«™", "æ•…å®®ç«™(ä¸­èˆˆå·´å£«)", "éºŸå…‰ç«™", "ä¸‰é‡ç«™(ä¸­èˆˆå·´å£«)", "æ–°å¸‚ç«™(æ·¡æ°´å®¢é‹)", "å…«é‡Œç«™(æ·¡æ°´å®¢é‹)", "æ¡ƒåœ’ç«™", "åŒ—å£«ç§‘å……é›»ç«™(å…‰è¯å·´å£«)"],
    "MetropolitanTransport": ["å…§æ¹–ç«™", "è¬èŠ³ç«™", "é™½æ˜å±±ç«™", "æ±åœ’ç«™", "è˜†æ´²ç«™", "æ¾å¾·ç«™", "æ¦®ç¸½ç«™", "å³èˆˆè¡—ç«™", "ä¸­å’Œç«™", "å››æµ·ç«™(è‡ºåŒ—å®¢é‹)", "å‡Œé›²ç«™", "æ±æ¹–ç«™", "æ¾è·ç«™", "éºŸå…‰ç«™", "èˆŠèŠç«™", "å£«æ—ç«™", "å»ºåŒ—ç«™", "æ–°èŠç«™", "è˜‡æ¾³ç«™", "åŸºéš†ç«™", "æ—å£ç«™(å°åŒ—å®¢é‹)", "æ–°èŠäºŒç«™(é¦–éƒ½å®¢é‹)", "è±¡é ­åŸ”åœè»Šå ´(å°åŒ—å®¢é‹)", "æ–°åº—ç«™(å°åŒ—å®¢é‹)", "æ°‘ç”Ÿç«™"],
    "FuhobusInc": ["å¤§æ­¦å´™ç«™"],
    "Kuang-HuaBus": ["æ±æ¹–ç«™", "åŒ—å³°ç«™", "åŒ—å£«ç§‘ç«™", "å¤©æ±ç«™", "å¤©è¥¿ç«™", "æµ·å°ˆç«™", "æ•…å®®ç«™", "éºŸå…‰ç«™", "ä¸­å’Œç«™", "åŸºéš†ç«™(åŸºéš†å®¢é‹)"],
    "RoyalBus": ["åŠ æŠ•ç«™"],
    "TaoyuanBus": ["ä¸­å£¢å…¬è»Šç«™", "è§€éŸ³ç«™", "å¤§æºªç«™", "ä¸­å£¢ç«™", "ç«¹åœç«™", "é¾æ½­ç«™", "å¤§åœ’ç«™", "ä¸‰å³½ç«™", "æ¡ƒåœ’å…¬è»Šç«™", "ä¸­å£¢ç«™"],
    "ZhongliBus": ["ä¸­å£¢ç«™", "æ¡ƒåœ’ç«™"],
    "YatungBus": ["æ–°åº—ç«™", "æ–°ç«¹ç«™"],
    "KamalanBus": ["å¤§åœ’ç«™", "ç¾…æ±ç«™"],
    "YosemiteBus": ["æ–°ç«¹ç«™"],
    "taisibus": ["æ–—å…­ç«™", "è™å°¾è¥¿ç«™", "åŒ—æ¸¯ç«™", "è¥¿èºç«™", "æ–—å—ç«™", "ç«¹å±±ç«™"],
    "NANTOUBU": ["å°ä¸­å¹²åŸç«™", "é«˜éµå°ä¸­ç«™", "è‰å±¯æœå‹™è™•", "åŸ”é‡Œè½‰é‹ç«™", "æ—¥æœˆæ½­ç«™"],
    "GreenTransit": ["ä¸­èˆˆç«™"],
    "AlishanBus": ["å¤ªä¿ç«™"],
    "YunlinBus": ["é›²ç§‘å¤§ç«™"],
    "SOLARbus": ["æ–—å…­ç«™", "è¥¿èºç«™", "éº¥å¯®ç«™"],
    "ChiayiBus": ["ç¸½å…¬å¸", "ä¸­å±±ç¸½ç«™", "åŒ—æ¸¯ç«™", "æœ´å­ç«™"],
    "TainanBus": ["é ‚æ±ç«™", "èŒ„è£ç«™", "ä»å¾·è½‰é‹ç«™ï¼ˆèƒ¸è…”ç—…é™¢æ—)", "å¡­å—é‡Œ", "ä¸‹é¯¤é¯“ç«™"],
    "SinhuaBus": ["å®‰å¹³å·¥æ¥­å€", "è‡ºå—ç«è»Šç«™", "ä½³é‡Œç«™", "æ–°åŒ–ç«™", "éº»è±†ç«™", "ç‰äº•ç«™", "æ¥ è¥¿ç«™"],
    "SingingBus": ["ç¸½å…¬å¸", "æ–°ç‡Ÿç«™", "ç™½æ²³ç«™"],
    "Han-ChengBus": ["é‡‘ç…æ¹–ç«™", "æ–°ç‡Ÿç«™"],
    "GreatCityLifeBus": ["åŠ æ˜Œç«™", "å°æ¸¯ç«™", "å·¦ç‡Ÿå—ç«™", "å‰é®ç«™", "å»ºè»ç«™"],
    "KaohsiungBus": ["ç¸½å…¬å¸", "æ—åœ’ç«™", "å°ç‰çƒç«™", "é³³å±±ç«™", "å¤§é †ç«™", "å»ºåœ‹ç«™", "æ¥ æ¢“ç«™", "å²¡å±±ç«™", "èŒ„è£ç«™", "æ——å±±è½‰é‹ç«™", "æ——å±±åŒ—ç«™", "ç¾æ¿ƒç«™", "å…­é¾œç«™", "ç”²ä»™ç«™", "å°å—ç«™", "æ°´é–€è½‰é‹ç«™"],
    "SouthTaiwanBus": ["é«˜é›„ç«™"],
    "E-DaBus": ["ç¾©å¤§ç«™"],
    "PingTungBus": ["å±æ±ç«™", "å±ç§‘å¤§", "é‡Œæ¸¯ç«™", "é«˜æ¨¹ç«™", "ç¾æ¿ƒç«™", "æ°´é–€ç«™", "é¹½åŸ”ç«™", "æ½®å·ç«™", "æ±æ¸¯ç«™", "æ‹å¯®ç«™", "æ†æ˜¥ç«™", "å…±ç‡Ÿä¸­å¿ƒ"],
    "TarokoBus": ["æ±è¯å¤§å­¸ç«™",],
    "PuyumaTransportation": ["æ›´ç”Ÿè·¯è»Šå» "],
    "phpto": ["é¦¬å…¬ç¸½ç«™"],
    "matsuebus": ["åŒ—ç«¿", "å—ç«¿", "æ±è’", "è¥¿è’", "æ±å¼•"],
    "Kinmen": ["é‡‘åŸç«™(é‡‘åŸåœè»Šå ´)", "å±±å¤–ç«™(å»ºè¯åœè»Šå ´)", "æ²™ç¾ç«™", "çƒˆå¶¼ç«™"]
    
};

// ç›£è½æ¥­è€…é¸æ“‡ (ä½¿ç”¨ç¨ç«‹å‡½å¼ï¼Œé¿å…é‡è¤‡ç¶å®š)
document.getElementById("operator").addEventListener("change", function updateManufacturerOptions() {
  const selectedOperator = this.value;
  const manufacturerSelect = document.getElementById("manufacturer");

  manufacturerSelect.innerHTML = "";

  if (operatorToManufacturer[selectedOperator]) {
    const defaultOption = document.createElement("option");
    defaultOption.value = "";
    defaultOption.textContent = "--- è«‹é¸æ“‡è»Šå»  ---";
    defaultOption.disabled = true;
    defaultOption.selected = true;
    manufacturerSelect.appendChild(defaultOption);

    operatorToManufacturer[selectedOperator].forEach(m => {
      const option = document.createElement("option");
      option.value = m;
      option.textContent = m;
      manufacturerSelect.appendChild(option);
    });
  } else {
    const option = document.createElement("option");
    option.value = "";
    option.textContent = "ç„¡å°æ‡‰è»Šå» è³‡æ–™";
    manufacturerSelect.appendChild(option);
  }
});

// è»Šè™Ÿè¼¸å…¥æ™‚è‡ªå‹•è½‰å¤§å¯« 
document.getElementById("busNumber").addEventListener("input", function() {
  this.value = this.value.toUpperCase();
});


// --- 4. èªè­‰ç›¸é—œå‡½å¼ ---

function updateAuthUI(user) {
  const loginForm = document.getElementById("loginForm");
  const userInfo = document.getElementById("userInfo");
  const userEmail = document.getElementById("userEmail");

  if (user) {
    userEmail.textContent = user.email;
    loginForm.style.display = "none";
    userInfo.style.display = "block";
    loadRecords(user.uid); 
  } else {
    loginForm.style.display = "block";
    userInfo.style.display = "none";
    document.getElementById("recordTable").querySelector("tbody").innerHTML = "";
    globalRecords = []; // ç™»å‡ºæ¸…ç©º
    editDocId = null;
  }
}

async function signup() {
  const email = document.getElementById("email").value;
  const password = document.getElementById("password").value;
  if (password.length < 6) {
    alert("å¯†ç¢¼é•·åº¦éœ€è‡³å°‘ 6 ä½ã€‚");
    return;
  }
  try {
    await auth.createUserWithEmailAndPassword(email, password);
    alert("è¨»å†ŠæˆåŠŸï¼å·²è‡ªå‹•ç™»å…¥ã€‚");
  } catch (error) {
    alert("è¨»å†Šå¤±æ•—ï¼š" + error.message);
  }
}

async function login() {
  const email = document.getElementById("email").value;
  const password = document.getElementById("password").value;
  try {
    await auth.signInWithEmailAndPassword(email, password);
    alert("ç™»å…¥æˆåŠŸï¼");
  } catch (error) {
    alert("ç™»å…¥å¤±æ•—ï¼š" + error.message);
  }
}

function logout() {
  auth.signOut();
  alert("å·²ç™»å‡ºã€‚");
  document.getElementById("surveyForm").reset();
  updateTimestamp();
}

// ç›£è½ç™»å…¥ç‹€æ…‹è®ŠåŒ–ï¼Œæ±ºå®šè¼‰å…¥å“ªäº›è³‡æ–™
auth.onAuthStateChanged(updateAuthUI);

// --- 5. æ¬„ä½è¼”åŠ©å‡½å¼ ---

// è‡ªå‹•å¡«å…¥æ™‚é–“æˆ³è¨˜ & æ˜ŸæœŸ
function updateTimestamp() {
    const now = new Date();
    document.getElementById("timestamp").value = now.toLocaleString(); 
    
    const weekdays = ["æ—¥","ä¸€","äºŒ","ä¸‰","å››","äº”","å…­"];
    document.getElementById("weekday").value = "æ˜ŸæœŸ" + weekdays[now.getDay()];
}

// é¡¯ç¤ºåœ¨è¡¨æ ¼ + é»æ“Šè¼‰å…¥è¡¨å–®
function addRow(record, docId) {
    const tbody = document.getElementById("recordTable").querySelector("tbody");
    const formattedTimestamp = record.timestamp ? record.timestamp.toDate().toLocaleString() : 'N/A';
    
    const row = tbody.insertRow(-1); 

    const data = [
      formattedTimestamp,
      record.weekday,
      OPERATOR_NAMES[record.operator] || record.operator,
      record.manufacturer,
      record.routeCode,
      record.busNumber,
      BUSTYPE_NAMES[record.busType] || record.busType,
      record.note
    ];

    data.forEach(val => {
        const cell = row.insertCell();
        cell.textContent = val;
    });

    // é»æ“Šåˆ— â†’ è¼‰å…¥åˆ°è¡¨å–®
    row.addEventListener("click", () => loadToForm(docId));
}

function loadToForm(docId) {
    db.collection("busRecords").doc(docId).get().then(doc => {
      if (doc.exists) {
        const record = doc.data();
        
        document.getElementById("timestamp").value = record.timestamp.toDate().toLocaleString();
        document.getElementById("weekday").value = record.weekday;
        
        const operatorSelect = document.getElementById("operator");
        operatorSelect.value = record.operator;
        operatorSelect.dispatchEvent(new Event('change'));

        setTimeout(() => { 
           document.getElementById("manufacturer").value = record.manufacturer;
        }, 50);

        document.getElementById("routeCode").value = record.routeCode;
        document.getElementById("busNumber").value = record.busNumber;
        document.getElementById("busType").value = record.busType;
        document.getElementById("note").value = record.note;

        editDocId = docId; 
      }
    });
}

// --- 6. CRUD å‡½å¼ & çµ±è¨ˆ ---

async function saveData() {
    const user = auth.currentUser;
    if (!user) {
        alert("è«‹å…ˆç™»å…¥æ‰èƒ½å„²å­˜ç´€éŒ„ï¼");
        return;
    }

    const operator = document.getElementById("operator").value;
    const manufacturer = document.getElementById("manufacturer").value;
    const busType = document.getElementById("busType").value;
    const busNumber = document.getElementById("busNumber").value;

    if (!operator || operator === "") { alert("è«‹é¸æ“‡å®¢é‹æ¥­è€…ï¼"); return; }
    if (!manufacturer || manufacturer === "") { alert("è«‹é¸æ“‡è»Šå» ï¼"); return; }
    if (!busType || busType === "") { alert("è«‹é¸æ“‡è»Šå‹ï¼"); return; }
    if (busNumber.trim() === "") { alert("è«‹å¡«å¯«è»Šè™Ÿï¼"); return; }

    const record = {
        userId: user.uid,
        timestamp: firebase.firestore.FieldValue.serverTimestamp(), 
        weekday: document.getElementById("weekday").value,
        operator: operator,
        manufacturer: manufacturer,
        routeCode: document.getElementById("routeCode").value,
        busNumber: busNumber.toUpperCase(),
        busType: busType,
        note: document.getElementById("note").value
    };

    try {
        await db.collection("busRecords").add(record);
        alert("ç´€éŒ„å„²å­˜æˆåŠŸï¼");
        document.getElementById("surveyForm").reset();
        updateTimestamp();

    } catch (e) {
        console.error("å¯«å…¥ Firestore éŒ¯èª¤: ", e);
        alert("å„²å­˜å¤±æ•—ã€‚");
    }
}

async function deleteRecord() {
    if (editDocId === null) {
        alert("è«‹å…ˆé¸æ“‡è¦åˆªé™¤çš„ç´€éŒ„ï¼");
        return;
    }
    if (!confirm("ç¢ºå®šè¦åˆªé™¤é€™ç­†ç´€éŒ„å—ï¼Ÿ")) return;

    try {
        await db.collection("busRecords").doc(editDocId).delete();
        alert("ç´€éŒ„åˆªé™¤æˆåŠŸï¼");
        document.getElementById("surveyForm").reset();
        updateTimestamp();
        editDocId = null;
    } catch (e) {
        console.error("åˆªé™¤ Firestore éŒ¯èª¤: ", e);
        alert("åˆªé™¤å¤±æ•—ã€‚");
    }
}

async function deleteAllRecords() {
    const user = auth.currentUser;
    if (!user) {
        alert("è«‹å…ˆç™»å…¥æ‰èƒ½åŸ·è¡Œåˆªé™¤æ“ä½œï¼");
        return;
    }

    if (!confirm("è­¦å‘Šï¼æ‚¨ç¢ºå®šè¦åˆªé™¤æ‰€æœ‰æ­ä¹˜ç´€éŒ„å—ï¼Ÿæ­¤æ“ä½œä¸å¯é€†ï¼")) return;

    try {
        const snapshot = await db.collection("busRecords")
            .where("userId", "==", user.uid)
            .get();

        if (snapshot.size === 0) {
            alert("æ‚¨çš„å¸³æˆ¶ä¸­æ²’æœ‰ç´€éŒ„éœ€è¦åˆªé™¤ã€‚");
            return;
        }

        const batch = db.batch();
        let deleteCount = 0;
        
        snapshot.docs.forEach(doc => {
            batch.delete(doc.ref);
            deleteCount++;
        });

        await batch.commit();

        alert(`æˆåŠŸåˆªé™¤ ${deleteCount} ç­†ç´€éŒ„ï¼`);
        document.getElementById("surveyForm").reset();
        updateTimestamp();
        editDocId = null;

    } catch (e) {
        console.error("æ‰¹é‡åˆªé™¤éŒ¯èª¤: ", e);
        alert("åˆªé™¤å¤±æ•—ã€‚è«‹æª¢æŸ¥æ‚¨çš„ Firestore æ¬Šé™ã€‚");
    }
}


async function saveEdit() {
    if (editDocId === null) {
        alert("è«‹å…ˆé¸æ“‡è¦ä¿®æ”¹çš„ç´€éŒ„ï¼");
        return;
    }
    
    const operator = document.getElementById("operator").value;
    const manufacturer = document.getElementById("manufacturer").value;
    const busType = document.getElementById("busType").value;
    const busNumber = document.getElementById("busNumber").value;
    
    if (!operator || !manufacturer || !busType || busNumber.trim() === "") {
        alert("å®¢é‹æ¥­è€…ã€è»Šå» ã€è»Šå‹å’Œè»Šè™Ÿç‚ºå¿…å¡«æ¬„ä½ï¼");
        return; 
    }

    const updatedRecord = {
        weekday: document.getElementById("weekday").value,
        operator: operator,
        manufacturer: manufacturer,
        routeCode: document.getElementById("routeCode").value,
        busNumber: busNumber.toUpperCase(), 
        busType: busType,
        note: document.getElementById("note").value
    };

    try {
        await db.collection("busRecords").doc(editDocId).update(updatedRecord);
        alert("ç´€éŒ„ä¿®æ”¹æˆåŠŸï¼");
        editDocId = null;
    } catch (e) {
        console.error("ä¿®æ”¹ Firestore éŒ¯èª¤: ", e);
        alert("ä¿®æ”¹å¤±æ•—ã€‚");
    }
}

// è¼‰å…¥ç´€éŒ„ + æ›´æ–°å…¨åŸŸè®Šæ•¸
function loadRecords(userId) {
    const tbody = document.getElementById("recordTable").querySelector("tbody");

    db.collection("busRecords")
        .where("userId", "==", userId)
        .orderBy("timestamp", "desc") 
        .onSnapshot((snapshot) => {
            tbody.innerHTML = "";
            globalRecords = []; // æ¸…ç©ºèˆŠè³‡æ–™
            
            snapshot.docs.forEach(doc => {
                const data = doc.data();
                globalRecords.push(data); // å­˜å…¥å…¨åŸŸè®Šæ•¸ä¾›çµ±è¨ˆä½¿ç”¨
                addRow(data, doc.id);
            });
        }, error => {
            console.error("Firestore ç›£è½éŒ¯èª¤: ", error);
            alert("è³‡æ–™è¼‰å…¥å¤±æ•—ã€‚");
        });
}

function exportCSV() {
    const user = auth.currentUser;
    if (!user) {
        alert("è«‹å…ˆç™»å…¥æ‰èƒ½åŒ¯å‡ºç´€éŒ„ï¼");
        return;
    }

    if (globalRecords.length === 0) {
        alert("æ²’æœ‰ç´€éŒ„å¯ä¾›åŒ¯å‡ºã€‚");
        return;
    }

    const records = globalRecords.map(data => {
        return {
            "æ™‚é–“æˆ³è¨˜": data.timestamp ? data.timestamp.toDate().toLocaleString() : 'N/A',
            "æ˜ŸæœŸ": data.weekday,
            "å®¢é‹æ¥­è€…": OPERATOR_NAMES[data.operator] || data.operator,
            "è»Šå» ": data.manufacturer,
            "è·¯ç·šç¢¼": data.routeCode,
            "è»Šè™Ÿ": data.busNumber,
            "è»Šå‹": BUSTYPE_NAMES[data.busType] || data.busType,
            "å‚™è¨»": data.note
        };
    });

    const worksheet = XLSX.utils.json_to_sheet(records);
    const workbook = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(workbook, worksheet, "æ­ä¹˜ç´€éŒ„");
    
    const excelBuffer = XLSX.write(workbook, { bookType: 'csv', type: 'array' });
    const data = new Blob([excelBuffer], {type: 'text/csv;charset=utf-8;'});
    
    saveAs(data, `BusRecords_${new Date().toISOString().slice(0, 10)}.csv`);
    alert("CSV åŒ¯å‡ºæˆåŠŸï¼");
}

// --- 7. çµ±è¨ˆåŠŸèƒ½èˆ‡æ¨¡æ…‹è¦–çª— ---

function showStats() {
    if (globalRecords.length === 0) {
        alert("ç›®å‰æ²’æœ‰è³‡æ–™å¯ä¾›çµ±è¨ˆï¼");
        return;
    }

    const modal = document.getElementById("statsModal");
    modal.style.display = "block";

    // 1. åŸºç¤æ•¸å­—
    document.getElementById("totalRides").textContent = globalRecords.length;
    const uniqueBuses = new Set(globalRecords.map(r => r.busNumber)).size;
    document.getElementById("uniqueBuses").textContent = uniqueBuses;

    // 2. è¨ˆç®—çµ±è¨ˆæ•¸æ“š
    const opCounts = {};
    const routeCounts = {};
    const busCounts = {};

    globalRecords.forEach(r => {
        // å®¢é‹
        const opName = OPERATOR_NAMES[r.operator] || r.operator;
        opCounts[opName] = (opCounts[opName] || 0) + 1;

        // è·¯ç·š (è™•ç†ç©ºå€¼)
        const rt = r.routeCode ? r.routeCode : "(æœªå¡«å¯«)";
        routeCounts[rt] = (routeCounts[rt] || 0) + 1;

        // è»Šè™Ÿ
        const bn = r.busNumber;
        busCounts[bn] = (busCounts[bn] || 0) + 1;
    });

    renderChart("topOperators", opCounts, 5);
    renderChart("topRoutes", routeCounts, 5);
    renderChart("topBusNumbers", busCounts, 5);
}

function closeStats() {
    document.getElementById("statsModal").style.display = "none";
}

// ã€æ–°å¢ã€‘è»Šè™Ÿçµ±è¨ˆåˆ—è¡¨é‚è¼¯
function showBusStats() {
    if (globalRecords.length === 0) {
        alert("ç›®å‰æ²’æœ‰è³‡æ–™å¯ä¾›åˆ—è¡¨ï¼");
        return;
    }

    const modal = document.getElementById("busStatsModal");
    modal.style.display = "block";
    
    const tbody = document.getElementById("busListBody");
    tbody.innerHTML = ""; // æ¸…ç©ºèˆŠè³‡æ–™

    // 1. æ•´ç†è³‡æ–™ï¼šä»¥è»Šè™Ÿç‚º Key
    const busMap = {};
    
    globalRecords.forEach(r => {
        const busNum = r.busNumber || "UNKNOWN";
        if (!busMap[busNum]) {
            busMap[busNum] = {
                count: 0,
                // å–ç¬¬ä¸€ç­†æ‰¾åˆ°çš„æ¥­è€…è³‡æ–™ä½œç‚ºä»£è¡¨ (é€šå¸¸ä¸€å°è»Šåªæœƒå±¬æ–¼ä¸€é–“å®¢é‹)
                operator: OPERATOR_NAMES[r.operator] || r.operator
            };
        }
        busMap[busNum].count++;
    });

    // 2. è½‰æ›ç‚ºé™£åˆ—ä¸¦æ’åº (ä¾ç…§è»Šè™Ÿ A-Z)
    const sortedBusList = Object.entries(busMap)
        .map(([num, data]) => ({
            num: num,
            count: data.count,
            operator: data.operator
        }))
        .sort((a, b) => a.num.localeCompare(b.num, 'en', { numeric: true }));

    // 3. ç”¢ç”Ÿè¡¨æ ¼ HTML
    sortedBusList.forEach(item => {
        const row = tbody.insertRow();
        
        const cellNum = row.insertCell();
        cellNum.textContent = item.num;
        cellNum.style.fontWeight = "bold";

        const cellCount = row.insertCell();
        cellCount.textContent = item.count;

        const cellOp = row.insertCell();
        cellOp.textContent = item.operator;
    });
}

function closeBusStats() {
    document.getElementById("busStatsModal").style.display = "none";
}

// é»æ“Šè¦–çª—å¤–éƒ¨é—œé–‰ (åŒ…å«å…©å€‹æ¨¡æ…‹è¦–çª—)
window.onclick = function(event) {
    const statsModal = document.getElementById("statsModal");
    const busModal = document.getElementById("busStatsModal");
    
    if (event.target == statsModal) {
        statsModal.style.display = "none";
    }
    if (event.target == busModal) {
        busModal.style.display = "none";
    }
}

// ç”¢ç”Ÿé•·æ¢åœ– HTML
function renderChart(elementId, dataObj, limit) {
    const container = document.getElementById(elementId);
    container.innerHTML = "";

    // è½‰ç‚ºé™£åˆ—ä¸¦æ’åº
    const sorted = Object.entries(dataObj)
        .sort((a, b) => b[1] - a[1])
        .slice(0, limit);

    if (sorted.length === 0) return;

    const maxVal = sorted[0][1]; // ç”¨æœ€å¤§å€¼ä¾†è¨ˆç®— bar çš„æ¯”ä¾‹

    sorted.forEach(([label, value]) => {
        const percentage = (value / maxVal) * 100;
        
        const row = document.createElement("div");
        row.className = "stat-row";
        
        row.innerHTML = `
            <div class="stat-label" title="${label}">${label}</div>
            <div class="stat-bar-container">
                <div class="stat-bar" style="width: ${percentage}%;"></div>
                <div class="stat-value">${value}æ¬¡</div>
            </div>
        `;
        container.appendChild(row);
    });
}


// --- 8. Excel åŒ¯å…¥åŠŸèƒ½ ---

function createReverseMap(mapObj) {
    return Object.fromEntries(Object.entries(mapObj).map(([key, value]) => [value, key]));
}

const REVERSE_OPERATOR_NAMES = createReverseMap(OPERATOR_NAMES);
const REVERSE_BUSTYPE_NAMES = createReverseMap(BUSTYPE_NAMES);

function parseTwDate(dateStr) {
    if (typeof dateStr === 'number') {
        return new Date(Math.round((dateStr - 25569) * 86400 * 1000));
    }
    if (!dateStr || typeof dateStr !== 'string') return new Date();

    let cleanStr = dateStr.trim();
    if (cleanStr.includes("ä¸Šåˆ") || cleanStr.includes("ä¸‹åˆ")) {
        const isPM = cleanStr.includes("ä¸‹åˆ");
        let temp = cleanStr.replace("ä¸Šåˆ", "").replace("ä¸‹åˆ", "").trim();
        let parts = temp.split(/\s+/);
        if (parts.length >= 2) {
             let datePart = parts[0];
             let timePart = parts[1];
             let [h, m, s] = timePart.split(':').map(Number);
             if (isPM && h < 12) h += 12;
             if (!isPM && h === 12) h = 0;
             let d = new Date(`${datePart} ${h}:${m}:${s}`);
             if (!isNaN(d.getTime())) return d;
        }
    }
    let d = new Date(dateStr);
    return isNaN(d.getTime()) ? new Date() : d;
}

function handleFileSelect(input) {
    const user = auth.currentUser;
    if (!user) {
        alert("è«‹å…ˆç™»å…¥æ‰èƒ½åŒ¯å…¥è³‡æ–™ï¼");
        input.value = ""; 
        return;
    }

    const file = input.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, {type: 'array'});
            const firstSheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[firstSheetName];
            const jsonData = XLSX.utils.sheet_to_json(worksheet, {raw: false});
            
            if (jsonData.length === 0) {
                alert("æª”æ¡ˆå…§å®¹ç‚ºç©ºï¼");
                return;
            }

            if (!confirm(`åµæ¸¬åˆ° ${jsonData.length} ç­†è³‡æ–™ï¼Œç¢ºå®šè¦åŒ¯å…¥å—ï¼Ÿ`)) {
                input.value = "";
                return;
            }

            processImportData(jsonData, user.uid);

        } catch (error) {
            console.error("è®€å–æª”æ¡ˆéŒ¯èª¤:", error);
            alert("è®€å– Excel å¤±æ•—ï¼Œè«‹ç¢ºèªæª”æ¡ˆæ ¼å¼æ­£ç¢ºã€‚");
        }
        input.value = ""; 
    };
    reader.readAsArrayBuffer(file);
}

async function processImportData(data, userId) {
    let successCount = 0;
    let failCount = 0;
    
    for (const row of data) {
        try {
            let operatorCode = REVERSE_OPERATOR_NAMES[row['å®¢é‹æ¥­è€…']];
            if (!operatorCode) operatorCode = "Other";
            
            let busTypeCode = REVERSE_BUSTYPE_NAMES[row['è»Šå‹']];
            if (!busTypeCode) busTypeCode = "Other";

            let timestampVal = parseTwDate(row['æ™‚é–“æˆ³è¨˜']);
            const weekMap = ["æ—¥", "ä¸€", "äºŒ", "ä¸‰", "å››", "äº”", "å…­"];
            const calculatedWeekday = "æ˜ŸæœŸ" + weekMap[timestampVal.getDay()];

            const newRecord = {
                userId: userId,
                timestamp: firebase.firestore.Timestamp.fromDate(timestampVal),
                weekday: calculatedWeekday, 
                operator: operatorCode,
                manufacturer: row['è»Šå» '] || "",
                routeCode: row['è·¯ç·šç¢¼'] ? String(row['è·¯ç·šç¢¼']) : "",
                busNumber: row['è»Šè™Ÿ'] ? String(row['è»Šè™Ÿ']).toUpperCase() : "UNKNOWN",
                busType: busTypeCode,
                note: row['å‚™è¨»'] || "Excel åŒ¯å…¥"
            };

            await db.collection("busRecords").add(newRecord);
            successCount++;
        } catch (err) {
            console.error("åŒ¯å…¥å–®ç­†å¤±æ•—:", err, row);
            failCount++;
        }
    }
    alert(`åŒ¯å…¥å®Œæˆï¼\næˆåŠŸï¼š${successCount} ç­†\nå¤±æ•—ï¼š${failCount} ç­†`);
}

updateTimestamp();
</script>
</body>
</html>